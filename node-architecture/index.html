<!DOCTYPE html><html lang="fr"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.04a8a8db8bab771741ce.css">code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#f8f8f2}.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.3.25"/><link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-b3b573358bfc66d89e1e95dbf8319c09.css"/><link rel="canonical" href="https://ludovicwyffels.dev/node-architecture/" data-baseprotocol="https:" data-basehost="ludovicwyffels.dev"/><title data-react-helmet="true">Architecture d&#x27;un projet node.js Bulletproof</title><link data-react-helmet="true" rel="icon" href="/static/favicon-36e47e74810a0d8c32a77f495c49cf8e.ico" type="image/x-icon"/><meta data-react-helmet="true" name="description" content="Une architecture de projet simple mais puissante pour les APIs REST de node.js"/><meta data-react-helmet="true" property="og:site_name" content="Blog de Ludo"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="Architecture d&#x27;un projet node.js Bulletproof"/><meta data-react-helmet="true" property="og:description" content="Une architecture de projet simple mais puissante pour les APIs REST de node.js"/><meta data-react-helmet="true" property="og:url" content="https://ludovicwyffels.github.io/node-architecture/"/><meta data-react-helmet="true" property="og:image" content="https://ludovicwyffels.github.io/static/7b5ca6b968847300f44022d2d8670c4a/c20aa/rock-zen.jpg"/><meta data-react-helmet="true" property="article:published_time" content="2019-04-20T08:00:00.000Z"/><meta data-react-helmet="true" property="article:tag" content="Architecture"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:title" content="Architecture d&#x27;un projet node.js Bulletproof"/><meta data-react-helmet="true" name="twitter:description" content="Une architecture de projet simple mais puissante pour les APIs REST de node.js"/><meta data-react-helmet="true" name="twitter:url" content="https://ludovicwyffels.github.io/node-architecture/"/><meta data-react-helmet="true" name="twitter:image" content="https://ludovicwyffels.github.io/static/7b5ca6b968847300f44022d2d8670c4a/c20aa/rock-zen.jpg"/><meta data-react-helmet="true" name="twitter:label1" content="Written by"/><meta data-react-helmet="true" name="twitter:data1" content="ludo"/><meta data-react-helmet="true" name="twitter:label2" content="Filed under"/><meta data-react-helmet="true" name="twitter:data2" content="Architecture"/><meta data-react-helmet="true" property="og:image:width" content="2250"/><meta data-react-helmet="true" property="og:image:height" content="1500"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script>
  window.excludeGAPaths=[/^(?:\/preview\/(?:(?!(?:\/|^)\.).)*?)$/];
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-138733938-1', 'auto', {"sampleRate":100,"siteSpeedSampleRate":10});
      
      
      
      }
      </script><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>            
              (adsbygoogle = window.adsbygoogle || []).push({
                google_ad_client: "ca-pub-4398886056385267",
                enable_page_level_ads: true
              });
          </script><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link as="script" rel="preload" href="/component---src-templates-post-tsx-c8600eb906ed08e678bd.js"/><link as="script" rel="preload" href="/2-36a9968ca3e4df27bb3f.js"/><link as="script" rel="preload" href="/0-06c48bb9820bc4bb3623.js"/><link as="script" rel="preload" href="/app-daa521a8615e5a15cced.js"/><link as="script" rel="preload" href="/styles-c067a6144121cde7a59c.js"/><link as="script" rel="preload" href="/webpack-runtime-470f81c458f8d846d003.js"/><link as="fetch" rel="preload" href="/static/d/595/path---node-architecture-7-f-4-aba-ayXPEB4Bd0Zv2sMuGUWVtraLQ.json" crossorigin="use-credentials"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="post-template"><style data-emotion-css="1f94ib9">html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font:inherit;font-size:100%;vertical-align:baseline;}body{line-height:1;}ol,ul{list-style:none;}blockquote,q{quotes:none;}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none;}table{border-spacing:0;border-collapse:collapse;}img{max-width:100%;}html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;}*,*:before,*:after{box-sizing:inherit;}a{background-color:transparent;}a:active,a:hover{outline:0;}b,strong{font-weight:bold;}i,em,dfn{font-style:italic;}h1{margin:0.67em 0;font-size:2em;}small{font-size:80%;}sub,sup{position:relative;font-size:75%;line-height:0;vertical-align:baseline;}sup{top:-0.5em;}sub{bottom:-0.25em;}img{border:0;}svg:not(:root){overflow:hidden;}mark{background-color:#fdffb6;}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em;}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit;}button{overflow:visible;border:none;}button,select{text-transform:none;}button,html input[type='button'],input[type='reset'],input[type='submit']{cursor:pointer;-webkit-appearance:button;}button[disabled],html input[disabled]{cursor:default;}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0;}input{line-height:normal;}input:focus{outline:none;}input[type='checkbox'],input[type='radio']{box-sizing:border-box;padding:0;}input[type='number']::-webkit-inner-spin-button,input[type='number']::-webkit-outer-spin-button{height:auto;}input[type='search']{box-sizing:content-box;-webkit-appearance:textfield;}input[type='search']::-webkit-search-cancel-button,input[type='search']::-webkit-search-decoration{-webkit-appearance:none;}legend{padding:0;border:0;}textarea{overflow:auto;}table{border-spacing:0;border-collapse:collapse;}td,th{padding:0;}html{overflow-x:hidden;overflow-y:scroll;font-size:62.5%;-webkit-tap-highlight-color:rgba(0,0,0,0);}body{overflow-x:hidden;color:#3b474d;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;font-size:1.5rem;line-height:1.6em;font-weight:400;font-style:normal;-webkit-letter-spacing:0;-moz-letter-spacing:0;-ms-letter-spacing:0;letter-spacing:0;text-rendering:optimizeLegibility;background:#fff;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-moz-font-feature-settings:'liga' on;}::selection{text-shadow:none;background:#cbeafb;}hr{position:relative;display:block;width:100%;margin:2.5em 0 3.5em;padding:0;height:1px;border:0;border-top:1px solid #e4eaed;}audio,canvas,iframe,img,svg,video{vertical-align:middle;}fieldset{margin:0;padding:0;border:0;}textarea{resize:vertical;}p,ul,ol,dl,blockquote{margin:0 0 1.5em 0;}ol,ul{padding-left:1.3em;padding-right:1.5em;}ol ol,ul ul,ul ol,ol ul{margin:0.5em 0 1em;}ul{list-style:disc;}ol{list-style:decimal;}ul,ol{max-width:100%;}li{margin:0.5em 0;padding-left:0.3em;line-height:1.6em;}dt{float:left;margin:0 20px 0 0;width:120px;color:#15171A;font-weight:500;text-align:right;}dd{margin:0 0 5px 0;text-align:left;}blockquote{margin:1.5em 0;padding:0 1.6em 0 1.6em;border-left:#e5eff5 0.5em solid;}blockquote p{margin:0.8em 0;font-size:1.2em;font-weight:300;}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;font-size:0.9em;opacity:0.8;}blockquote small:before{content:'\2014 \00A0';}blockquote cite{font-weight:bold;}blockquote cite a{font-weight:normal;}a{color:#26a6ed;-webkit-text-decoration:none;text-decoration:none;}a:hover{-webkit-text-decoration:underline;text-decoration:underline;}h1,h2,h3,h4,h5,h6{margin-top:0;line-height:1.15;font-weight:700;text-rendering:optimizeLegibility;}h1{margin:0 0 0.5em 0;font-size:5rem;font-weight:700;}@media (max-width:500px){h1{font-size:2.2rem;}}h2{margin:1.5em 0 0.5em 0;font-size:2rem;}@media (max-width:500px){h2{font-size:1.8rem;}}h3{margin:1.5em 0 0.5em 0;font-size:1.8rem;font-weight:500;}@media (max-width:500px){h3{font-size:1.7rem;}}h4{margin:1.5em 0 0.5em 0;font-size:1.6rem;font-weight:500;}h5{margin:1.5em 0 0.5em 0;font-size:1.4rem;font-weight:500;}h6{margin:1.5em 0 0.5em 0;font-size:1.4rem;font-weight:500;}body{background:#f4f8fb;}</style><style data-emotion-css="1mpact1">.css-1mpact1 .site-main{background:#fff;padding-bottom:4vw;}</style><style data-emotion-css="16s8vhf">.css-16s8vhf{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100vh;}.css-16s8vhf .site-main{background:#fff;padding-bottom:4vw;}</style><div class="css-16s8vhf e1xc5d5q0"><style data-emotion-css="1r9y6t9">.css-1r9y6t9{position:relative;padding:0 4vw;position:relative;padding-top:12px;padding-bottom:12px;color:#fff;background:#0a0b0c no-repeat center center;background-size:cover;}</style><header class="css-1r9y6t9"><style data-emotion-css="s2cjas">.css-s2cjas{margin:0 auto;max-width:1040px;width:100%;}</style><div class="css-s2cjas"><style data-emotion-css="mzgqix">.css-mzgqix{position:relative;z-index:300;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;overflow-y:hidden;height:40px;font-size:1.25rem;}</style><nav class="css-mzgqix"><style data-emotion-css="72a8gi">.css-72a8gi{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;margin-right:10px;padding-bottom:80px;-webkit-letter-spacing:0.5px;-moz-letter-spacing:0.5px;-ms-letter-spacing:0.5px;letter-spacing:0.5px;white-space:nowrap;-ms-overflow-scrolling:touch;}@media (max-width:700px){.css-72a8gi{margin-right:0;padding-left:4vw;}}</style><div class="css-72a8gi e19zdhsh0"><style data-emotion-css="1trdsxq">.css-1trdsxq{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin:0 0 0 -12px;padding:0;list-style:none;}.css-1trdsxq li{display:block;margin:0;padding:0;text-transform:uppercase;}.css-1trdsxq li a{display:block;margin:0;padding:10px 12px;color:#fff;opacity:0.8;}.css-1trdsxq li a:hover{-webkit-text-decoration:none;text-decoration:none;opacity:1;}</style><ul role="menu" class="css-1trdsxq"><li role="menuitem"><a href="/">Home</a></li><li role="menuitem"><a href="/tags/best/">Bests Posts</a></li><li role="menuitem"><a href="/about">About</a></li></ul></div><style data-emotion-css="cniab2">.css-cniab2{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;height:40px;}@media (max-width:700px){.css-cniab2{display:none;}}</style><div class="css-cniab2 e19zdhsh1"><style data-emotion-css="1im5alu">.css-1im5alu{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.css-1im5alu a:last-of-type{padding-right:20px;}</style><div class="css-1im5alu e19zdhsh2"><style data-emotion-css="1pe98dy">.css-1pe98dy{font-size:1.2em;font-weight:500;}</style><span class="css-1pe98dy"> Follow me </span><style data-emotion-css="1l1dftb">.css-1l1dftb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0;padding:10px;color:#fff;opacity:0.8;}.css-1l1dftb:hover{opacity:1;}.css-1l1dftb svg{height:1.8rem;fill:#fff;}</style><a href="https://github.com/ludovicwyffels" title="Github" target="_blank" rel="noopener noreferrer" class="css-1l1dftb"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a></div></div></nav></div></header><style data-emotion-css="rtkcef">.css-rtkcef{z-index:100;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;position:relative;padding:0 4vw;}</style><main id="site-main" class="site-main css-rtkcef"><div class="css-s2cjas"><style data-emotion-css="vyvttm">.css-vyvttm{position:relative;z-index:50;}</style><article class="css-vyvttm"><style data-emotion-css="29d3h2">.css-29d3h2{margin:0 auto;padding:6vw 3vw 3vw;max-width:1040px;text-align:center;}@media (max-width:500px){.css-29d3h2{padding:14vw 3vw 10vw;}}</style><header class="css-29d3h2 e1jmyeao0"><style data-emotion-css="njyqyw">.css-njyqyw{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:#738a94;font-size:1.4rem;font-weight:600;text-transform:uppercase;}@media (max-width:500px){.css-njyqyw{font-size:1.2rem;line-height:1.3em;}}</style><section class="css-njyqyw e1jmyeao1"><style data-emotion-css="et0m70">.css-et0m70{color:#3eb0ef;}</style><time dateTime="2019-04-20T08:00:00.000Z" class="css-et0m70 e1jmyeao2">20 April 2019</time><style data-emotion-css="m5hopj">.css-m5hopj{display:inline-block;margin:0 6px 1px;}</style><span class="css-m5hopj e1jmyeao5">/</span><a href="/tags/architecture/">Architecture</a></section><style data-emotion-css="ldwdh4">.css-ldwdh4{margin:0;color:#0b0c0e;}@media (max-width:500px){.css-ldwdh4{font-size:2.9rem;}}</style><h1 class="css-ldwdh4 e1jmyeao3">Architecture d&#x27;un projet node.js Bulletproof</h1></header><style data-emotion-css="1y0hjh3">.css-1y0hjh3{margin:0 -10vw -165px;height:800px;background:#c5d2d9 center center;background-size:cover;border-radius:5px;}@media (max-width:1170px){.css-1y0hjh3{margin:0 -4vw -100px;height:600px;border-radius:0;}}@media (max-width:800px){.css-1y0hjh3{height:400px;}}@media (max-width:500px){.css-1y0hjh3{margin-bottom:4vw;height:350px;}}</style><figure class="css-1y0hjh3 e1jmyeao4"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;height:100%"><div style="width:100%;padding-bottom:66.66666666666667%"></div><img src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAQX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAv/aAAwDAQACEAMQAAABpznuGEpc/wD/xAAaEAEBAAIDAAAAAAAAAAAAAAABAgARAxIh/9oACAEBAAEFAiBK6zTxmx9qdus//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEREv/aAAgBAwEBPwGIwj//xAAYEQACAwAAAAAAAAAAAAAAAAAAAQIREv/aAAgBAgEBPwG5G2f/xAAZEAACAwEAAAAAAAAAAAAAAAAAARAhMRH/2gAIAQEABj8Cvgk9Lcaaf//EABgQAQEBAQEAAAAAAAAAAAAAAAEAESEx/9oACAEBAAE/ITnRgGapmh2ZnE1yevV//9oADAMBAAIAAwAAABCL/wD/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxBif//EABYRAQEBAAAAAAAAAAAAAAAAAAEQMf/aAAgBAgEBPxAB2f8A/8QAHBABAQACAgMAAAAAAAAAAAAAAREAQSGBYXHR/9oACAEBAAE/EDBaCJT7l6ghJLrjWP6Ll3ggFO3IiIXir7xVTtmf/9k=" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:0.5s"/><noscript><picture><img sizes="(max-width: 2250px) 100vw, 2250px" srcset="/static/7b5ca6b968847300f44022d2d8670c4a/f8f18/rock-zen.jpg 930w,
/static/7b5ca6b968847300f44022d2d8670c4a/0e6ff/rock-zen.jpg 1860w,
/static/7b5ca6b968847300f44022d2d8670c4a/c20aa/rock-zen.jpg 2250w" src="/static/7b5ca6b968847300f44022d2d8670c4a/c20aa/rock-zen.jpg" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></figure><style data-emotion-css="t1ipa4">.css-t1ipa4{position:relative;margin:0 auto;padding:70px 100px 0;min-height:230px;font-family:Georgia,serif;font-size:2.2rem;line-height:1.6em;background:#fff;text-align:justify;}@media (max-width:1170px){.css-t1ipa4{padding:5vw 7vw 0;}}@media (max-width:800px){.css-t1ipa4{font-size:1.9rem;}}.css-t1ipa4:before{content:'';position:absolute;top:15px;left:-5px;z-index:-1;display:block;width:20px;height:200px;background:rgba(39,44,49,0.15);-webkit-filter:blur(5px);filter:blur(5px);-webkit-transform:rotate(-5deg);-ms-transform:rotate(-5deg);transform:rotate(-5deg);}.css-t1ipa4:after{content:'';position:absolute;top:15px;right:-5px;z-index:-1;display:block;width:20px;height:200px;background:rgba(39,44,49,0.15);-webkit-filter:blur(5px);filter:blur(5px);-webkit-transform:rotate(5deg);-ms-transform:rotate(5deg);transform:rotate(5deg);}.css-t1ipa4 h1{text-align:center;}.css-t1ipa4 h1,.css-t1ipa4 h2,.css-t1ipa4 h3,.css-t1ipa4 h4,.css-t1ipa4 h5,.css-t1ipa4 h6,.css-t1ipa4 p,.css-t1ipa4 ul,.css-t1ipa4 ol,.css-t1ipa4 dl,.css-t1ipa4 pre,.css-t1ipa4 blockquote,.css-t1ipa4 .post-full-comments,.css-t1ipa4 .footnotes{min-width:100%;}.css-t1ipa4 li{word-break:break-word;}.css-t1ipa4 li p{margin:0;}.css-t1ipa4 a{color:#000;word-break:break-word;box-shadow:#3eb0ef 0 -1px 0 inset;}.css-t1ipa4 a:hover{color:#3eb0ef;-webkit-text-decoration:none;text-decoration:none;}.css-t1ipa4 strong,.css-t1ipa4 em{color:#0a0b0c;}.css-t1ipa4 small{display:inline-block;line-height:1.6em;}.css-t1ipa4 li:first-child{margin-top:0;}.css-t1ipa4 .gatsby-resp-image-link{box-shadow:none;}.css-t1ipa4 img,.css-t1ipa4 video{display:block;margin:1.5em auto;max-width:1040px;height:auto;}@media (max-width:1040px){.css-t1ipa4 img,.css-t1ipa4 video{width:100%;}}.css-t1ipa4 img[src$='#full']{max-width:none;width:100vw;}.css-t1ipa4 img + br + small{display:block;margin-top:-3em;margin-bottom:1.5em;text-align:center;}.css-t1ipa4 iframe{margin:0 auto !important;}.css-t1ipa4 blockquote{margin:0 0 1.5em;padding:0 1.5em;border-left:#3eb0ef 3px solid;}.css-t1ipa4 blockquote p{margin:0 0 1em 0;color:inherit;font-size:inherit;line-height:inherit;font-style:italic;}.css-t1ipa4 blockquote p:last-child{margin-bottom:0;}.css-t1ipa4 code{padding:0 5px 2px;font-size:0.8em;line-height:1em;font-weight:400 !important;background:#e5eff5;border-radius:3px;}.css-t1ipa4 p code{word-break:break-word;padding-left:0.5em;padding-right:0.5em;}.css-t1ipa4 pre{overflow-x:auto;margin:1.5em 0 3em;padding:20px;max-width:100%;border:#131517 1px solid;color:#e5eff5;font-size:1.4rem;line-height:1.5em;background:#0e1012;border-radius:5px;}.css-t1ipa4 pre code{padding:0;font-size:inherit;line-height:inherit;background:transparent;}.css-t1ipa4 pre code:not(span){color:inherit;}.css-t1ipa4 .gatsby-resp-iframe-wrapper{margin:1.5em 0 3em;}.css-t1ipa4 hr{margin:4vw 0;}.css-t1ipa4 hr:after{content:'';position:absolute;top:-15px;left:50%;display:block;margin-left:-10px;width:1px;height:30px;background:#e4eaed;box-shadow:#fff 0 0 0 5px;-webkit-transform:rotate(45deg);-ms-transform:rotate(45deg);transform:rotate(45deg);}.css-t1ipa4 h1,.css-t1ipa4 h2,.css-t1ipa4 h3,.css-t1ipa4 h4,.css-t1ipa4 h5,.css-t1ipa4 h6{color:#0b0c0e;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;}.css-t1ipa4 h1{margin:0.5em 0 0.2em 0;font-size:4.6rem;font-weight:700;}@media (max-width:500px){.css-t1ipa4 h1{font-size:2.8rem;}}.css-t1ipa4 h2{margin:0.5em 0 0.2em 0;font-size:3.6rem;font-weight:700;}@media (max-width:500px){.css-t1ipa4 h2{font-size:2.6rem;}}.css-t1ipa4 h3{margin:0.5em 0 0.2em 0;font-size:2.8rem;font-weight:700;}@media (max-width:500px){.css-t1ipa4 h3{font-size:2.2rem;}}.css-t1ipa4 h4{margin:0.5em 0 0.2em 0;font-size:2.8rem;font-weight:700;}@media (max-width:500px){.css-t1ipa4 h4{font-size:2.2rem;}}.css-t1ipa4 h5{display:block;margin:0.5em 0;padding:1em 0 1.5em;border:0;color:#3eb0ef;font-family:Georgia,serif;font-size:3.2rem;line-height:1.35em;text-align:center;}@media (min-width:1180px){.css-t1ipa4 h5{max-width:1060px;}}@media (max-width:500px){.css-t1ipa4 h5{padding:0 0 0.5em;font-size:2.2rem;}}.css-t1ipa4 h6{margin:0.5em 0 0.2em 0;font-size:2.3rem;font-weight:700;}@media (max-width:500px){.css-t1ipa4 h6{font-size:2rem;}}.css-t1ipa4 table{display:inline-block;overflow-x:auto;margin:0.5em 0 2.5em;max-width:100%;width:auto;border-spacing:0;border-collapse:collapse;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;font-size:1.6rem;white-space:nowrap;vertical-align:top;}.css-t1ipa4 table{-webkit-overflow-scrolling:touch;background:radial-gradient(ellipse at left,rgba(0,0,0,0.2) 0%,rgba(0,0,0,0) 75%) 0 center,radial-gradient(ellipse at right,rgba(0,0,0,0.2) 0%,rgba(0,0,0,0) 75%) 100% center;background-attachment:scroll,scroll;background-size:10px 100%,10px 100%;background-repeat:no-repeat;}.css-t1ipa4 table td:first-child{background-image:linear-gradient( to right,rgba(255,255,255,1) 50%,rgba(255,255,255,0) 100% );background-size:20px 100%;background-repeat:no-repeat;}.css-t1ipa4 table td:last-child{background-image:linear-gradient( to left,rgba(255,255,255,1) 50%,rgba(255,255,255,0) 100% );background-position:100% 0;background-size:20px 100%;background-repeat:no-repeat;}.css-t1ipa4 table th{color:#15171A;font-size:1.2rem;font-weight:700;-webkit-letter-spacing:0.2px;-moz-letter-spacing:0.2px;-ms-letter-spacing:0.2px;letter-spacing:0.2px;text-align:left;text-transform:uppercase;background-color:#f4f8fb;}.css-t1ipa4 table th,.css-t1ipa4 table td{padding:6px 12px;border:#e9ebec 1px solid;}@media (max-width:500px){.css-t1ipa4{padding:0;}.css-t1ipa4:before{display:none;}.css-t1ipa4:after{display:none;}}</style><section class="post-full-content css-t1ipa4 edcwe810"><div class="post-content"><h1>Architecture d’un projet node.js Bulletproof</h1>
<h2>Introduction</h2>
<p>Express.js est un excellent framework pour la création d’une API REST en node.js, mais il ne vous donne aucune indication sur la manière d’organiser votre projet node.js.</p>
<p>Bien que cela puisse paraître stupide, c’est un problème réel.</p>
<p>Une organisation correcte de la structure de votre projet node.js évitera la duplication de code, améliorera la stabilité et, éventuellement, vous aidera à faire évoluer vos services si cela est effectué correctement.</p>
<p>Cet article est une recherche approfondie, issue de mes années d’expérience dans le traitement d’un projet node.js mal structuré, de mauvais schémas et d’innombrables heures de refactorisation de code et de déplacements.</p>
<h2>Table des matières</h2>
<ul>
<li><a href="#folder">La structure du dossier 🏢</a></li>
<li><a href="#architecture">Architecture à 3 couches 🥪</a></li>
<li><a href="#service">Couche service 💼</a></li>
<li><a href="#pubsub">Couche Pub/Sub ️️️️🎙️️</a></li>
<li><a href="#di">Injection de dépendances 💉</a></li>
<li><a href="#test">Test unitaire 🕵🏻</a></li>
<li><a href="#cron">Cron Jobs et tâches récurrentes ⚡</a></li>
<li><a href="#configs">Configurations et secrets 🤫</a></li>
<li><a href="#loaders">Loaders 🏗️</a></li>
</ul>
<p><a name="folder"></a></p>
<h2>La structure du dossier 🏢</h2>
<p>Voici la structure du projet node.js dont je parle.</p>
<p>J’utilise ceci dans chaque service d’API REST de node.js que je construis. Voyons en détail ce que chaque composant fait.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">src
│   app.js          # App entry point
└───api             # Express route controllers for all the endpoints of the app
└───config          # Environment variables and configuration related stuff
└───jobs            # Jobs definitions for agenda.js
└───loaders         # Split the startup process into modules
└───models          # Database models
└───services        # All the business logic is here
└───subscribers     # Event handlers for async task
└───types           # Type declaration files (d.ts) for Typescript</code></pre></div>
<p>C’est plus qu’un moyen de commander des fichiers javascript…</p>
<p><a name="architecture"></a></p>
<h2>Architecture à 3 couches 🥪</h2>
<p>L’idée est d’utiliser le <strong>principe de séparation des préoccupations</strong> pour éloigner la logique métier des routes de l’API node.js.</p>
<p><a class="gatsby-resp-image-link" href="/static/e7549783fc618ca44dcc8daef066a986/48906/server_layers.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:755px">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:78.41059602649007%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAABi0lEQVQ4y4WU646CMBCFff8X9AcCMZFE7oKKF8DufpOcCRjdbTJpaWfOzJzTsnm9XmGaptC2bei67qP1fR/O57PZNx9snuewCb/j8XgYIBvP5zOM4+jG9/V6NbDL5bLa10xBTdPY2gFx/jQISpIkbLfbsN/vw7dBwhWgMtzvd7Pb7eZrDB9M3xSgNXHEk3wDh7SKA1loj8OqqsIwDN6qzpnhi4r1zYwvWAYoYcTH6XQKWZZZIlUmUxckFIeKM0DxVNe1Z2R9OBxsTeYlBXyjOiLirxtAV4A6h2x+Gjgej0dLkuf5V/EAXonCBoOylzMgqAtomqZW2XLID14dkEVRFH5BCaIy1ohEu8y0S4WckwSuMfzg1FqWKMtsAIgChMF0GxgEItoyRmu/NlRAdsBoM4oiB3436CnL0mMknqsMh5AuNfXU2NdToypmkuMnKqS+X+y/nh687HY74yuOY7tKPEMA/n16kEvJqkY0AIoItMiMeAByrqqJ48wB9bdALSmHwdXyyelpvvvJSPIDQV3ZnsiBHJsAAAAASUVORK5CYII=&#x27;);background-size:cover;display:block"></span>
    <picture>
        <source srcSet="/static/e7549783fc618ca44dcc8daef066a986/8ffb1/server_layers.webp 293w, /static/e7549783fc618ca44dcc8daef066a986/17bf8/server_layers.webp 585w, /static/e7549783fc618ca44dcc8daef066a986/7f4af/server_layers.webp 755w" sizes="(max-width: 755px) 100vw, 755px" type="image/webp"/>
        <source srcSet="/static/e7549783fc618ca44dcc8daef066a986/f93ee/server_layers.png 293w, /static/e7549783fc618ca44dcc8daef066a986/8c0a8/server_layers.png 585w, /static/e7549783fc618ca44dcc8daef066a986/48906/server_layers.png 755w" sizes="(max-width: 755px) 100vw, 755px" type="image/png"/>
        <img class="gatsby-resp-image-image" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white" src="/static/e7549783fc618ca44dcc8daef066a986/48906/server_layers.png" alt="3 layer pattern" title=""/>
      </picture>
  </span>
  </a></p>
<p>Parce qu’un jour, vous voudrez utiliser votre logique métier sur un outil CLI, ou ne pas aller très loin, dans une tâche récurrente.</p>
<p>Et faire un appel API du serveur node.js à lui-même, ce n’est pas une bonne idée…</p>
<p> <a class="gatsby-resp-image-link" href="/static/8ba15b5b22a1a677396ca792a04418e3/39973/server_layers_2.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:652px">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:81.13496932515338%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAABd0lEQVQ4y42TWY/CMAyE+f8/ri+8tQ9V1Zaj0Isbepj9LDlKsyxaS0NC6kzG42Q1z7NM0ySv12uB5/P5FX7eMAxiPCv5CT4cDgc5n89yOp0U1+tV7ve73G63BR6Ph1wuF5fHnqZplBhSJeQPBH6QlKap5Hkum81GiqJQJEmixH7YwYQjhADpKGDsuk52u50cj0ep69qN+/1eCcLcBeE4jrqIfMC8bVvdiHIfkGRZJtvtVv9b6XBoyfyAsAQI/wo8DMteNAXZlNP3vZ6GZ6hgYwhyyLV8qgHWaechi1a+Kab7eIe/5iHfUQKYE9j0qykshsGpKC3LUkcQ2kPgpSMkASVVVbkS8A81dh99sEZDuLfMzQJ3D/2m2OgrpjQzHBCUbxb5e7UpNrGXABl3jfIo2crxX4opY84at8IOdh5Swqd7Z0ThuoE9NI1x0ZTwXtnzW6/XEsexPsMoilRZGB+fHr6ECkni7uHnN4X2qlyXqT/06r8wUmvaG9Vj2kbgv3TmAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
    <picture>
        <source srcSet="/static/8ba15b5b22a1a677396ca792a04418e3/8ffb1/server_layers_2.webp 293w, /static/8ba15b5b22a1a677396ca792a04418e3/17bf8/server_layers_2.webp 585w, /static/8ba15b5b22a1a677396ca792a04418e3/7f0f0/server_layers_2.webp 652w" sizes="(max-width: 652px) 100vw, 652px" type="image/webp"/>
        <source srcSet="/static/8ba15b5b22a1a677396ca792a04418e3/f93ee/server_layers_2.png 293w, /static/8ba15b5b22a1a677396ca792a04418e3/8c0a8/server_layers_2.png 585w, /static/8ba15b5b22a1a677396ca792a04418e3/39973/server_layers_2.png 652w" sizes="(max-width: 652px) 100vw, 652px" type="image/png"/>
        <img class="gatsby-resp-image-image" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white" src="/static/8ba15b5b22a1a677396ca792a04418e3/39973/server_layers_2.png" alt="3 layer pattern for node.js REST API" title=""/>
      </picture>
  </span>
  </a></p>
<h3>Ne placez pas votre logique métier dans les contrôleurs !!!</h3>
<p>Vous pouvez être tenté d’utiliser simplement les contrôleurs express.js pour stocker la logique métier de votre application, mais cela devient rapidement du code spaghetti. Dès que vous aurez besoin d’écrire des tests unitaires, vous finirez par avoir affaire à des mocks complexes pour des objets express.js tel que <code class="language-text">req</code> ou <code class="language-text">res</code>.</p>
<p>il est difficile de distinguer quand une réponse doit être envoyée et quand continuer le traitement en “arrière-plan”, disons après que la réponse a été envoyée au client.</p>
<p>Voici un exemple de ce qu’il ne faut pas faire.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">route<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token comment">// This should be a middleware or should be handled by a library like Joi.</span>
  <span class="token keyword">const</span> userDTO <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> isUserValid <span class="token operator">=</span> validators<span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isUserValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Lot of business logic here...</span>
  <span class="token keyword">const</span> userRecord <span class="token operator">=</span> <span class="token keyword">await</span> UserModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> userRecord<span class="token punctuation">.</span>password<span class="token punctuation">;</span>
  <span class="token keyword">delete</span> userRecord<span class="token punctuation">.</span>salt<span class="token punctuation">;</span>
  <span class="token keyword">const</span> companyRecord <span class="token operator">=</span> <span class="token keyword">await</span> CompanyModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> companyDashboard <span class="token operator">=</span> <span class="token keyword">await</span> CompanyDashboard<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">,</span> companyRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">...</span>whatever<span class="token operator">...</span>


  <span class="token comment">// And here is the &#x27;optimization&#x27; that mess up everything.</span>
  <span class="token comment">// The response is sent to client...</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token punctuation">:</span> userRecord<span class="token punctuation">,</span> company<span class="token punctuation">:</span> companyRecord <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// But code execution continues :(</span>
  <span class="token keyword">const</span> salaryRecord <span class="token operator">=</span> <span class="token keyword">await</span> SalaryModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">,</span> companyRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  eventTracker<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span><span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span>userRecord<span class="token punctuation">,</span>companyRecord<span class="token punctuation">,</span>salaryRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  intercom<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gaAnalytics<span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span><span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span>userRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> EmailService<span class="token punctuation">.</span><span class="token function">startSignupSequence</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p><a name="service"></a></p>
<h2>Utilisez une couche de service pour votre logique métier 💼</h2>
<p>Cette couche est l’endroit où votre logique métier doit vivre.</p>
<p>C’est juste un ensemble de classes, suivant les principes SOLID appliqués à node.js.</p>
<p><em>Dans cette couche, il ne devrait exister aucune forme de “requête SQL”, utilisez la couche d’accès aux données pour cela.</em></p>
<ul>
<li>Éloignez votre code du routeur express.js</li>
<li>Ne transmettez pas l’objet req ou res à la couche service</li>
<li>Ne renvoyez aucun élément lié à la couche de transport HTTP, tel qu’un code d’état ou des en-têtes de la couche de service.</li>
</ul>
<p><strong>Exemple</strong></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">route<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">,</span> 
  validators<span class="token punctuation">.</span>userSignup<span class="token punctuation">,</span> <span class="token comment">// this middleware take care of validation</span>
  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// The actual responsability of the route layer.</span>
    <span class="token keyword">const</span> userDTO <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token comment">// Call to service layer.</span>
    <span class="token comment">// Abstraction on how to access the data layer and the business logic.</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> UserService<span class="token punctuation">.</span><span class="token function">Signup</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Return a response to client.</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Voici comment votre service travaillera dans les coulisses.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> UserModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> CompanyModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/company&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token keyword">async</span> <span class="token function">Signup</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> userRecord <span class="token operator">=</span> <span class="token keyword">await</span> UserModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> companyRecord <span class="token operator">=</span> <span class="token keyword">await</span> CompanyModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// needs userRecord to have the database id </span>
  <span class="token keyword">const</span> salaryRecord <span class="token operator">=</span> <span class="token keyword">await</span> SalaryModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">,</span> companyRecord<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// depends on user and company to be created</span>

  <span class="token operator">...</span>whatever

  <span class="token keyword">await</span> EmailService<span class="token punctuation">.</span><span class="token function">startSignupSequence</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span>

  <span class="token operator">...</span>do more stuff

  <span class="token keyword">return</span> <span class="token punctuation">{</span> user<span class="token punctuation">:</span> userRecord<span class="token punctuation">,</span> company<span class="token punctuation">:</span> companyRecord <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><a name="pubsub"></a></p>
<h2>Utilisez aussi un calque Pub/Sub 🎙️️</h2>
<p>Le modèle pub/sub va au-delà de l’architecture classique à 3 couches proposée ici, mais il est extrêmement utile.</p>
<p>Le simple endpoint de l’API node.js qui crée un utilisateur immédiatement, peut vouloir appeler des services tiers, peut-être à un service d’analyse, ou peut-être démarrer une séquence de courriels.</p>
<p>Tôt ou tard, cette simple opération “créer” fera plusieurs choses, et vous obtiendrez 1000 lignes de code, le tout en une seule fonction.</p>
<p>Cela viole le principe de la responsabilité unique.</p>
<p>Il est donc préférable de séparer les responsabilités dès le départ, afin que votre code reste maintenable.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> UserModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> CompanyModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/company&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> SalaryModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/salary&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">async</span> <span class="token function">Signup</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userRecord <span class="token operator">=</span> <span class="token keyword">await</span> UserModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> companyRecord <span class="token operator">=</span> <span class="token keyword">await</span> CompanyModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> salaryRecord <span class="token operator">=</span> <span class="token keyword">await</span> SalaryModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> salary<span class="token punctuation">)</span><span class="token punctuation">;</span>

    eventTracker<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span>
      <span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span>
      userRecord<span class="token punctuation">,</span>
      companyRecord<span class="token punctuation">,</span>
      salaryRecord
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    intercom<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>
      userRecord
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    gaAnalytics<span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>
      <span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span>
      userRecord
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> EmailService<span class="token punctuation">.</span><span class="token function">startSignupSequence</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span>

    <span class="token operator">...</span>more stuff

    <span class="token keyword">return</span> <span class="token punctuation">{</span> user<span class="token punctuation">:</span> userRecord<span class="token punctuation">,</span> company<span class="token punctuation">:</span> companyRecord <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre></div>
<p>Un appel impératif à un service dépendant n’est pas la meilleure façon de le faire.</p>
<p>Une meilleure approche est d’émettre un événement, c’est-à-dire “un utilisateur s’est inscrit avec cet email”.</p>
<p>Et vous avez terminé, c’est maintenant la responsabilité des listeners de faire leur travail.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> UserModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> CompanyModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/company&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> SalaryModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/salary&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">async</span> <span class="token function">Signup</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userRecord <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> companyRecord <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>companyModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>eventEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> user<span class="token punctuation">:</span> userRecord<span class="token punctuation">,</span> company<span class="token punctuation">:</span> companyRecord <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> userRecord
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre></div>
<p>Vous pouvez maintenant scinder les gestionnaires d’événements/listeners en plusieurs fichiers.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  eventTracker<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span>
    <span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span>
    user<span class="token punctuation">,</span>
    company<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  intercom<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>
    user
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  gaAnalytics<span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>
    <span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span>
    user
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> salaryRecord <span class="token operator">=</span> <span class="token keyword">await</span> SalaryModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> company<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> EmailService<span class="token punctuation">.</span><span class="token function">startSignupSequence</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Vous pouvez mettre les instruction en attente dans un bloc <code class="language-text">try-catch</code> ou vous pouvez simplement le laisser échouer et gérer le  ‘unhandledPromise’ <code class="language-text">process.on(&#x27;unhandledRejection&#x27;,cb)</code></p>
<p><a name="di"></a></p>
<h2>Injection de dépendances 💉</h2>
<p><code class="language-text">Dependency Injection</code> (D.I.) ou <code class="language-text">inversion of control</code> (IoC) est un modèle commun qui aidera l’organisation de votre code, en “injectant” ou en passant par le constructeur les dépendances de votre classe ou fonction.</p>
<p>De cette façon, vous aurez la possibilité d’injecter une “dépendance compatible” lorsque, par exemple, vous écrirez les tests unitaires pour le service, ou lorsque le service sera utilisé dans un autre contexte.</p>
<p><em>Code sans D.I.</em></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> UserModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> CompanyModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/company&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> SalaryModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/salary&#x27;</span><span class="token punctuation">;</span>  
<span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">Sigup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// Caling UserMode, CompanyModel, etc</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p><em>Code avec injection manuelle de dépendance</em></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">userModel<span class="token punctuation">,</span> companyModel<span class="token punctuation">,</span> salaryModel</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>userModel <span class="token operator">=</span> userModel<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>companyModel <span class="token operator">=</span> companyModel<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>salaryModel <span class="token operator">=</span> salaryModel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getMyUser</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// models available throug &#x27;this&#x27;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userModel<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Vous pouvez maintenant injecter des dépendances personnalisées.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> UserService <span class="token keyword">from</span> <span class="token string">&#x27;../services/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> UserModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> CompanyModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/company&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> salaryModelMock <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">calculateNetSalary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">42</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> userServiceInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span>userModel<span class="token punctuation">,</span> companyModel<span class="token punctuation">,</span> salaryModelMock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> userServiceInstance<span class="token punctuation">.</span><span class="token function">getMyUser</span><span class="token punctuation">(</span><span class="token string">&#x27;12346&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Le nombre de dépendances qu’un service peut avoir est infini, et refactoriser chaque instanciation de celui-ci lorsque vous en ajoutez un nouveau est une tâche ennuyeuse et sujette aux  erreurs.</p>
<p>C’est pourquoi des framework d’injection de dépendance ont été créés.</p>
<p>L’idée est de déclarer vos dépendances dans la classe, et quand vous avez besoin d’une instance de cette classe, vous appelez simplement le <code class="language-text">Service Locator</code>.</p>
<p>Voyons un exemple utilisant <a href="https://www.npmjs.com/package/typedi" target="_blank" rel="nofollow noopener noreferrer"><code class="language-text">typedi</code>, une bibliothèque npm</a> qui apporte l’injection de dépendances à node.js</p>
<p>Pour en savoir plus sur l’utilisation de <code class="language-text">typedi</code>, consultez la <a href="https://github.com/typestack/typedi" target="_blank" rel="nofollow noopener noreferrer">documentation officielle</a></p>
<p>AVERTISSEMENT exemple en typescript</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Service <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;typedi&#x27;</span><span class="token punctuation">;</span>
@<span class="token function">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token keyword">private</span> userModel<span class="token punctuation">,</span>
    <span class="token keyword">private</span> companyModel<span class="token punctuation">,</span> 
    <span class="token keyword">private</span> salaryModel</span>
  <span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">getMyUser</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userModel<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<blockquote>
<p>services/user.ts</p>
</blockquote>
<p>Maintenant <em>typedi</em> s’occupera de résoudre toute dépendance dont le <code class="language-text">UserService</code> a besoin.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Container <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;typedi&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> UserService <span class="token keyword">from</span> <span class="token string">&#x27;../services/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> userServiceInstance <span class="token operator">=</span> Container<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>UserService<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> userServiceInstance<span class="token punctuation">.</span><span class="token function">getMyUser</span><span class="token punctuation">(</span><span class="token string">&#x27;12346&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p><em>L’abus d’appels de localisateur de service est un anti-pattern</em></p>
<p>Utilisation de l’injection de dépendance avec Express.js dans Node.js</p>
<p>L’utilisation de D.I. dans express.js est la dernière pièce du puzzle de l’architecture de ce projet node.js.</p>
<p><strong>Couche de routage</strong></p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js">route<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">,</span> 
  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userDTO <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">const</span> userServiceInstance <span class="token operator">=</span> Container<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>UserService<span class="token punctuation">)</span> <span class="token comment">// Service locator</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span> <span class="token operator">=</span> userServiceInstance<span class="token punctuation">.</span><span class="token function">Signup</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Génial, le projet à l’air génial !
C’est tellement organisé que j’ai envie de coder quelque chose en ce moment.</p>
<p><a name="test"></a></p>
<h2>Un exemple de test unitaire 🕵🏻</h2>
<p>En utilisant l’injection de dépendance et ces modèles d’organisation, le test unitaire devient vraiment simple.</p>
<p>Vous n’avez pas besoin de simuler des objets req/res ou de require(…)</p>
<p><strong>exemple: Test unitaire pour la méthode d’inscription de l’utilisateur</strong></p>
<blockquote>
<p>tests/unit/services/user.js</p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> UserService <span class="token keyword">from</span> <span class="token string">&#x27;../../../src/services/user&#x27;</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;User service unit tests&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;Signup&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;Should create user record and emit user_signup event&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> eventEmitterService <span class="token operator">=</span> <span class="token punctuation">{</span>
        emit<span class="token punctuation">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> userModel <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">create</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>user<span class="token punctuation">,</span>
            _id<span class="token punctuation">:</span> <span class="token string">&#x27;mock-user-id&#x27;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> companyModel <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">create</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            owner<span class="token punctuation">:</span> user<span class="token punctuation">.</span>_id<span class="token punctuation">,</span>
            companyTaxId<span class="token punctuation">:</span> <span class="token string">&#x27;12345&#x27;</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> userInput<span class="token operator">=</span> <span class="token punctuation">{</span>
        fullname<span class="token punctuation">:</span> <span class="token string">&#x27;User Unit Test&#x27;</span><span class="token punctuation">,</span>
        email<span class="token punctuation">:</span> <span class="token string">&#x27;test@example.com&#x27;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> userService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span>userModel<span class="token punctuation">,</span> companyModel<span class="token punctuation">,</span> eventEmitterService<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> userRecord <span class="token operator">=</span> <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">SignUp</span><span class="token punctuation">(</span>teamId<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userInput<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">expect</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeDefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeDefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>eventEmitterService<span class="token punctuation">.</span>emit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p><a name="cron"></a></p>
<h2>Cron Jobs et tâches récurrentes ⚡</h2>
<p>Ainsi, maintenant que la logique métier est encapsulée dans la couche service, il est plus facile de l’utiliser depuis un job Cron.</p>
<p>Vous ne devriez jamais compter sur <code class="language-text">setTimeout</code> ou une autre façon primitive de retarder l’exécution du code, mais sur un framework qui persiste vos jobs, et l’exécution de ceux-ci, dans une base de données.</p>
<p>De cette façon, vous aurez le contrôle sur les jobs échoués, et la rétroaction de ceux qui réussissent.</p>
<p><a name="configs"></a></p>
<h2>Configurations et secrets 🤫</h2>
<p>Suivant les concepts éprouvés de <a href="https://12factor.net/" target="_blank" rel="nofollow noopener noreferrer">Twelve-Factor App</a> pour node.js, la meilleure approche pour stocker les clés API et les chaînes de connexions aux base de données, c’est en utilisant <strong>dotenv</strong>.</p>
<p>Mettez un fichier <code class="language-text">.env</code>, qui ne doit jamais être validé <em>(mais qui doit exister avec des valeurs par défaut dans votre référentiel)</em> puis, le paquet npm <code class="language-text">dotenv</code> charge le fichier <code class="language-text">.env</code> et insert les variables dans l’objet <code class="language-text">process.env</code> de node.js.</p>
<p>Cela pourrait suffire, mais j’aimerais ajouter une étape supplémentaire.
Avoir un fichier <code class="language-text">config/index.ts</code> où le paquet npm <code class="language-text">dotenv</code> et charge le fichier <code class="language-text">.env</code> et puis j’utilise un objet pour stocker les variables, dons nous avons une structure et un code d’autocomplétion.</p>
<blockquote>
<p>config/index.js</p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> dotenv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;dotenv&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// config() will read your .env file, parse the contents, assign it to process.env.</span>
dotenv<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  port<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span>
  databaseURL<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URI</span><span class="token punctuation">,</span>
  paypal<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    publicKey<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PAYPAL_PUBLIC_KEY</span><span class="token punctuation">,</span>
    secretKey<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PAYPAL_SECRET_KEY</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  paypal<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    publicKey<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PAYPAL_PUBLIC_KEY</span><span class="token punctuation">,</span>
    secretKey<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PAYPAL_SECRET_KEY</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mailchimp<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    apiKey<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MAILCHIMP_API_KEY</span><span class="token punctuation">,</span>
    sender<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MAILCHIMP_SENDER</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>De cette façon, vous évitez d’inonder votre code avec les instructions <code class="language-text">process.env.MY_RANDOM_VAR</code>, et en ayant l’autocomplétion vous n’avez pas besoin de savoir comment nommer la variable d’environnement.</p>
<p><a name="loaders"></a></p>
<h2>Loaders 🏗️</h2>
<p>J’ai pris ce modèle du <a href="https://www.npmjs.com/package/microframework-w3tec" target="_blank" rel="nofollow noopener noreferrer">microframework de W3Tech</a> mais sans dépendre de leur paquet.</p>
<p>L’idée est de diviser le processus de démarrage de votre service node.js en modules testables.</p>
<p>Voyons une initialisation d’application express.js classique</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;mongoose&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;express&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;body-parser&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;express-session&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;cors&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> errorhandler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;errorhandler&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/status&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token string">&#x27;/status&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;morgan&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&#x27;dev&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>setupForStripeWebhooks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;method-override&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">&#x27;/public&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span> secret<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SECRET</span><span class="token punctuation">,</span> cookie<span class="token punctuation">:</span> <span class="token punctuation">{</span> maxAge<span class="token punctuation">:</span> <span class="token number">60000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> resave<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> saveUninitialized<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useNewUrlParser<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./config/passport&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./models/user&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./models/company&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./routes&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;Not Found&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#x27;errors&#x27;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    message<span class="token punctuation">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
    error<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token operator">...</span> more stuff 

<span class="token operator">...</span> maybe start up Redis

<span class="token operator">...</span> maybe add more middlewares

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Your server is ready !`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Run the async function to start our server</span>
<span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Comme vous le voyez, cette partie de votre application peut être un vrai gâchis.</p>
<p>Voici une façon efficace d’y faire face.</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> loaders <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./loaders&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;express&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> loaders<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> expressApp<span class="token punctuation">:</span> app <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Your server is ready !`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Maintenant, les chargeurs ne sont plus que de minuscules fichiers avec un but concis</p>
<blockquote>
<p>loders/index.js</p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> expressLoader <span class="token keyword">from</span> <span class="token string">&#x27;./express&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> mongooseLoader <span class="token keyword">from</span> <span class="token string">&#x27;./mongoose&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> expressApp <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mongoConnection <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">mongooseLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;MongoDB Intialized&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">expressLoader</span><span class="token punctuation">(</span><span class="token punctuation">{</span> app<span class="token punctuation">:</span> expressApp <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;Express Intialized&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ... more loaders can be here</span>

  <span class="token comment">// ... Initialize agenda</span>
  <span class="token comment">// ... or Redis, or whatever you want}</span></code></pre></div>
<p>Le loader express</p>
<blockquote>
<p>loaders/express.js</p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> express <span class="token keyword">from</span> <span class="token string">&#x27;express&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> bodyParser <span class="token keyword">from</span> <span class="token string">&#x27;body-parser&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> cors <span class="token keyword">from</span> <span class="token string">&#x27;cors&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> app <span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> app<span class="token punctuation">:</span> express<span class="token punctuation">.</span>Application <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/status&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token string">&#x27;/status&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token string">&#x27;trust proxy&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;morgan&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&#x27;dev&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...More middlewares</span>

  <span class="token comment">// Return the express app</span>
  <span class="token keyword">return</span> app<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Le loader mongo</p>
<blockquote>
<p>loaders/mongoose.js</p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> mongoose <span class="token keyword">from</span> <span class="token string">&#x27;mongoose&#x27;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useNewUrlParser<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> connection<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>db<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p><a name="conclusion"></a></p>
<h2>Conclusion</h2>
<p>Nous plongeons en profondeur dans la structure d’un projet node.js testé en production, voici quelques conseils résumés:</p>
<ul>
<li>Utiliser une architecture à 3 couches.</li>
<li>Ne mettez pas votre logique métier dans les contrôleurs express.js</li>
<li>Ayez l’injection de dépendance pour votre tranquillité d’esprit.</li>
<li>Ne divulguez jamais vos mots de passe, secrets et clés API, utilisez un gestionnaire de configuration.</li>
<li>Divisez vos configurations de serveur node.js en petits modules qui peuvent être chargés indépendamment.</li>
</ul></div><br/></section><style data-emotion-css="1a0mcpy">.css-1a0mcpy{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin:0 auto;padding:3vw 0 6vw 0;max-width:840px;}</style><footer class="css-1a0mcpy e2mc3gh0"><style data-emotion-css="k008qs">.css-k008qs{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><section class="css-k008qs ewlt7wj0"><style data-emotion-css="2785xc">.css-2785xc{display:block;background:#e4eaed;border-radius:100%;object-fit:cover;margin-right:15px;width:60px;height:60px;}</style><img src="/static/5f2c129e42248a92c87b13b4293950cf/f6494/ghost.png" alt="ludo" class="css-2785xc"/><style data-emotion-css="fz4w57">.css-fz4w57 p{margin:0;color:#738a94;line-height:1.3em;}</style><section class="css-fz4w57 ewlt7wj2"><style data-emotion-css="1eii8n9">.css-1eii8n9{margin:8px 0 2px 0;padding:0;font-size:2rem;}.css-1eii8n9 a{color:#15171A;font-weight:700;}.css-1eii8n9 a:hover{-webkit-text-decoration:none;text-decoration:none;}</style><h4 class="css-1eii8n9 ewlt7wj1"><a href="/author/ludo/">Wyffels Ludovic<!-- --> - @<!-- -->ludo</a></h4><p>Développeur senior. Fullstack + DevOps</p></section></section><style data-emotion-css="1zye22">.css-1zye22{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-left:20px;}</style><div class="css-1zye22 e96tk9q0"><style data-emotion-css="1hp0auc">.css-1hp0auc{display:block;padding:9px 16px;border:#adbac0 1px solid;color:#738a94;font-size:1.2rem;line-height:1;font-weight:500;border-radius:20px;-webkit-transition:all ease 0.2s;transition:all ease 0.2s;}.css-1hp0auc:hover{border-color:#3eb0ef;color:#3eb0ef;-webkit-text-decoration:none;text-decoration:none;}</style><a class="css-1hp0auc" href="/author/ludo/">Read More</a></div></footer></article></div></main><style data-emotion-css="1x0l29j">.css-1x0l29j{position:relative;padding:0 4vw;}</style><aside class="read-next css-1x0l29j"><div class="css-s2cjas"><style data-emotion-css="12kejdt">.css-12kejdt{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;margin:0 -20px;padding:40px 0 0 0;}</style><div class="css-12kejdt e1jmyeao6"><style data-emotion-css="1676cyu">.css-1676cyu{position:relative;-webkit-flex:1 1 300px;-ms-flex:1 1 300px;flex:1 1 300px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;overflow:hidden;margin:0 20px 40px;padding:25px;color:#fff;background:#15171A center center;background-size:cover;border-radius:5px;box-shadow:rgba(39,44,49,0.06) 8px 14px 38px,rgba(39,44,49,0.03) 1px 3px 8px;background-image:url(/static/3121ecba869f33fbe0440169bf0844e9/883ab/blog-cover.jpg);}.css-1676cyu:before{content:"";position:absolute;top:0;right:0;bottom:0;left:0;display:block;background:linear-gradient(135deg,rgba(0,40,60,0.8) 0%,rgba(0,20,40,0.7) 100%);border-radius:5px;-webkit-backdrop-filter:blur(2px);backdrop-filter:blur(2px);}</style><article class="css-1676cyu e9ckwyc0"><style data-emotion-css="1d05jhl">.css-1d05jhl{position:relative;z-index:50;padding-top:20px;text-align:center;}</style><header class="css-1d05jhl e9ckwyc1"><style data-emotion-css="qbcumt">.css-qbcumt{display:block;font-size:1.3rem;line-height:1.3em;opacity:0.8;}</style><small class="css-qbcumt e9ckwyc2">— <!-- -->Blog de Ludo<!-- --> —</small><style data-emotion-css="y0gtj6">.css-y0gtj6{margin:0;padding:0 20px;color:#fff;font-size:3rem;line-height:1.2em;-webkit-letter-spacing:1px;-moz-letter-spacing:1px;-ms-letter-spacing:1px;letter-spacing:1px;}.css-y0gtj6 a{color:#fff;font-weight:300;-webkit-text-decoration:none;text-decoration:none;}.css-y0gtj6 a:hover{-webkit-text-decoration:none;text-decoration:none;}</style><h3 class="css-y0gtj6 e9ckwyc3"><a href="/tags/architecture/">Architecture</a></h3></header><style data-emotion-css="1x76w68">.css-1x76w68{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;height:80px;}.css-1x76w68 svg{width:40px;fill:transparent;stroke:#fff;stroke-width:0.5px;stroke-opacity:0.65;}</style><div class="css-1x76w68 e9ckwyc4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"></path></svg></div><style data-emotion-css="1mqgav7">.css-1mqgav7{position:relative;z-index:50;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;font-size:1.7rem;}.css-1mqgav7 ul{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;margin:0 auto;padding:0;text-align:center;list-style:none;}.css-1mqgav7 li{margin:0;padding:0;font-size:1.6rem;line-height:1.25em;font-weight:200;-webkit-letter-spacing:-0.5px;-moz-letter-spacing:-0.5px;-ms-letter-spacing:-0.5px;letter-spacing:-0.5px;}.css-1mqgav7 li a{display:block;padding:20px 0;border-bottom:rgba(255,255,255,0.3) 1px solid;color:#fff;font-weight:500;vertical-align:top;-webkit-transition:opacity 0.3s ease;transition:opacity 0.3s ease;}.css-1mqgav7 li:first-of-type a{padding-top:10px;}.css-1mqgav7 li a:hover{opacity:1;}</style><div class="css-1mqgav7 e9ckwyc5"><ul><li><a aria-current="page" class="" href="/node-architecture/">Architecture d&#x27;un projet node.js Bulletproof</a></li></ul></div><style data-emotion-css="t8u9qr">.css-t8u9qr{position:relative;margin:15px 0 3px 0;text-align:center;}.css-t8u9qr a{color:#fff;}</style><footer class="css-t8u9qr e9ckwyc6"><a href="/tags/architecture/">1 post<!-- --> →</a></footer></article><style data-emotion-css="1eugmea">.css-1eugmea{-webkit-flex:1 1 300px;-ms-flex:1 1 300px;flex:1 1 300px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;overflow:hidden;margin:0 20px 40px;min-height:300px;background:#fff center center;background-size:cover;border-radius:5px;box-shadow:rgba(39,44,49,0.06) 8px 14px 38px,rgba(39,44,49,0.03) 1px 3px 8px;-webkit-transition:all 0.5s ease;transition:all 0.5s ease;}.css-1eugmea:hover{box-shadow:rgba(39,44,49,0.07) 8px 28px 50px,rgba(39,44,49,0.04) 1px 6px 12px;-webkit-transition:all 0.4s ease;transition:all 0.4s ease;-webkit-transform:translate3D(0,-1px,0) scale(1.02);-ms-transform:translate3D(0,-1px,0) scale(1.02);transform:translate3D(0,-1px,0) scale(1.02);}</style><article class="post-card  css-1eugmea"><style data-emotion-css="kufnxr">.css-kufnxr{position:relative;display:block;overflow:hidden;border-radius:5px 5px 0 0;}</style><a class="post-card-image-link css-kufnxr" href="/js-conditions/"><style data-emotion-css="8kte6t">.css-8kte6t{width:auto;height:200px;background:#c5d2d9 no-repeat center center;background-size:cover;}</style><div class="post-card-image css-8kte6t e1674q8v0"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;height:100%"><div style="width:100%;padding-bottom:48.57142857142858%"></div><img src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwX/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAwX/2gAMAwEAAhADEAAAAdRWqzLSKH//xAAZEAADAAMAAAAAAAAAAAAAAAAAAQIQERL/2gAIAQEAAQUCKfKm08WQlr//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQIBAT8Bi4//xAAbEAACAQUAAAAAAAAAAAAAAAAAARARIUFRcf/aAAgBAQAGPwIqahdHbJ//xAAbEAEAAgIDAAAAAAAAAAAAAAABABEhMRBBUf/aAAgBAQABPyGWq0QF8NU8Ecy8Jrjbqf/aAAwDAQACAAMAAAAQ8+//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8Qqa//xAAXEQEBAQEAAAAAAAAAAAAAAAABABEh/9oACAECAQE/EAL2wcv/xAAcEAEAAQQDAAAAAAAAAAAAAAABABARIXExQWH/2gAIAQEAAT8QgDlyIbiKikSg486oKCHEl45XXJ//2Q==" alt="Comment écrire de meilleures conditions en JavaScript cover image" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:0.5s"/><noscript><picture><img sizes="(max-width: 560px) 100vw, 560px" srcset="/static/a1ef560e42893d6248a1c66369e728d8/9a396/js.jpg 560w" src="/static/a1ef560e42893d6248a1c66369e728d8/9a396/js.jpg" alt="Comment écrire de meilleures conditions en JavaScript cover image" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></div></a><style data-emotion-css="123mfn9">.css-123mfn9{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;}</style><div class="post-card-content css-123mfn9 e1674q8v1"><style data-emotion-css="t0tfly">.css-t0tfly{position:relative;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;display:block;padding:25px 25px 0;color:#15171A;}.css-t0tfly:hover{-webkit-text-decoration:none;text-decoration:none;}</style><a class="post-card-content-link css-t0tfly" href="/js-conditions/"><header class="post-card-header"><style data-emotion-css="z4f0wj">.css-z4f0wj{display:block;margin-bottom:4px;color:#738a94;font-size:1.2rem;line-height:1.15em;font-weight:500;-webkit-letter-spacing:0.5px;-moz-letter-spacing:0.5px;-ms-letter-spacing:0.5px;letter-spacing:0.5px;text-transform:uppercase;}</style><span class="css-z4f0wj e1674q8v2">Javascript</span><style data-emotion-css="8kn4zf">.css-8kn4zf{margin-top:0;}</style><h2 class="css-8kn4zf e1674q8v3">Comment écrire de meilleures conditions en JavaScript</h2></header><style data-emotion-css="1pcdrot">.css-1pcdrot{font-family:Georgia,serif;}</style><section class="css-1pcdrot e1674q8v4"><p> </p></section></a><style data-emotion-css="1uyhyqd">.css-1uyhyqd{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:flex-end;-webkit-box-align:flex-end;-ms-flex-align:flex-end;align-items:flex-end;padding:0 25px 25px;}</style><footer class="post-card-meta css-1uyhyqd e1674q8v5"><style data-emotion-css="rv6jj5">.css-rv6jj5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap-reverse;-ms-flex-wrap:wrap-reverse;flex-wrap:wrap-reverse;margin:0;padding:0;list-style:none;}</style><ul class="css-rv6jj5 e1674q8v6"></ul><style data-emotion-css="zb10i8">.css-zb10i8{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;margin-left:20px;color:#738a94;font-size:1.2rem;line-height:33px;font-weight:500;-webkit-letter-spacing:0.5px;-moz-letter-spacing:0.5px;-ms-letter-spacing:0.5px;letter-spacing:0.5px;text-transform:uppercase;}</style><span class="css-zb10i8 e1674q8v7">10<!-- --> min read</span></footer></div></article></div></div></aside><style data-emotion-css="p382uv">.css-p382uv{position:relative;padding:0 4vw;position:relative;padding-top:20px;padding-bottom:60px;color:#fff;background:#000;}</style><footer class="css-p382uv"><style data-emotion-css="fcb8o">.css-fcb8o{margin:0 auto;max-width:1040px;width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;color:rgba(255,255,255,0.7);font-size:1.3rem;}.css-fcb8o a{color:rgba(255,255,255,0.7);}.css-fcb8o a:hover{color:rgba(255,255,255,1);-webkit-text-decoration:none;text-decoration:none;}@media (max-width:650px){.css-fcb8o{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="css-fcb8o"><section class="copyright"><a href="/">Blog de Ludo</a> © <!-- -->2019</section><style data-emotion-css="j0kq43">.css-j0kq43{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}.css-j0kq43 a{position:relative;margin-left:20px;}.css-j0kq43 a:before{content:'';position:absolute;top:11px;left:-11px;display:block;width:2px;height:2px;background:#fff;border-radius:100%;}.css-j0kq43 a:first-of-type:before{display:none;}@media (max-width:650px){.css-j0kq43 a:first-child{margin-left:0;}}</style><nav class="css-j0kq43 e1v92iww0"><a href="/privacy">Privacy</a><a href="/terms">Terms</a><a href="https://github.com/ludovicwyffels" target="_blank" rel="noopener noreferrer">Github</a><a href="https://gitlab.com/ludovic.wyffels" target="_blank" rel="noopener noreferrer">GitLab</a></nav></div></footer></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-post-tsx","jsonName":"node-architecture-7f4","path":"/node-architecture/"};window.dataPath="595/path---node-architecture-7-f-4-aba-ayXPEB4Bd0Zv2sMuGUWVtraLQ";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-daa521a8615e5a15cced.js"],"component---src-templates-post-tsx":["/component---src-templates-post-tsx-c8600eb906ed08e678bd.js"],"component---src-templates-tags-tsx":["/component---src-templates-tags-tsx-2b6c7014dd9776419c29.js"],"component---src-templates-author-tsx":["/component---src-templates-author-tsx-67862ccb21f33788403e.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-6e0cad5d92c5b6b2e936.js"],"component---src-pages-about-tsx":["/component---src-pages-about-tsx-2839bc4312bbe35d59ac.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-e11e980857723b8d1393.js"],"component---src-pages-privacy-tsx":["/component---src-pages-privacy-tsx-39609af578508f08cdae.js"],"component---src-pages-terms-tsx":["/component---src-pages-terms-tsx-b9300804f06991545f0d.js"],"pages-manifest":["/pages-manifest-d022eb2531d6211dd0a9.js"]};/*]]>*/</script><script src="/webpack-runtime-470f81c458f8d846d003.js" async=""></script><script src="/styles-c067a6144121cde7a59c.js" async=""></script><script src="/app-daa521a8615e5a15cced.js" async=""></script><script src="/0-06c48bb9820bc4bb3623.js" async=""></script><script src="/2-36a9968ca3e4df27bb3f.js" async=""></script><script src="/component---src-templates-post-tsx-c8600eb906ed08e678bd.js" async=""></script><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>
            (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: &quot;ca-pub-4398886056385267&quot;,
              enable_page_level_ads: true
            });
          </script></body></html>
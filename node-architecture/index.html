<!DOCTYPE html><html lang="fr"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.5288cde64b59aff2f8d2.css">.authorCard-module--authorCardSection--3Xspq{display:flex}.authorCard-module--authorCardName--3HnMH{margin:8px 0 2px;padding:0;font-size:2rem}.authorCard-module--authorCardName--3HnMH a{color:#000;font-weight:700}.authorCard-module--authorCardName--3HnMH a:hover{text-decoration:none}.authorCard-module--authorCardContent--3jBBV p{margin:0;color:#647a83;line-height:1.3em}.siteNavLogo-module--container--2Eieh{flex-shrink:0;display:block;margin-right:24px;padding:11px 0;color:#fff;font-size:1.7rem;line-height:1em;font-weight:700;letter-spacing:-.5px}.siteNavLogo-module--container--2Eieh:hover{text-decoration:none}.siteNavLogo-module--container--2Eieh img{display:block;width:auto;height:21px}.footer-module--siteFooter--1ncU1{position:relative;padding:20px 4vw 60px;color:#fff;background:#000}.footer-module--siteFooter--1ncU1 .footer-module--content--3f5hY{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;color:hsla(0,0%,100%,.7);font-size:1.3rem}.footer-module--siteFooter--1ncU1 .footer-module--content--3f5hY a{color:hsla(0,0%,100%,.7)}.footer-module--siteFooter--1ncU1 .footer-module--content--3f5hY a:hover{color:#fff;text-decoration:none}@media (max-width:650px){.footer-module--siteFooter--1ncU1 .footer-module--content--3f5hY{flex-direction:column}}.footer-module--siteFooter--1ncU1 .footer-module--content--3f5hY nav{display:flex}.footer-module--siteFooter--1ncU1 .footer-module--content--3f5hY nav a{position:relative;margin-left:20px}.footer-module--siteFooter--1ncU1 .footer-module--content--3f5hY nav a:before{content:"";position:absolute;top:11px;left:-11px;display:block;width:2px;height:2px;background:#fff;border-radius:100%}.footer-module--siteFooter--1ncU1 .footer-module--content--3f5hY nav a:first-of-type:before{display:none}@media (max-width:650px){.footer-module--siteFooter--1ncU1 .footer-module--content--3f5hY nav a:first-of-type{margin-left:0}}.shared-module--outer--3ayIs{position:relative;padding:0 4vw}.shared-module--inner--35I1L{margin:0 auto;max-width:1040px;width:100%}.shared-module--SiteMain--1L3AH{z-index:100;flex-grow:1}.shared-module--SiteTitle--LzNSD{z-index:10;margin:0;padding:0;font-size:3.8rem;font-weight:700}.shared-module--SiteDescription--xZ-xT{z-index:10;margin:0;padding:5px 0;font-size:2.2rem;font-weight:300;letter-spacing:.5px;opacity:.8}.shared-module--PostFeed--yxeHl{position:relative;display:flex;flex-wrap:wrap;margin:0 -20px;padding:40px 0 0}@media (min-width:900px){.shared-module--PostFeedRaise--3lm-9{margin-top:-70px;padding-top:0}}.shared-module--SocialLink--Ya1gh{display:flex;justify-content:center;align-items:center;margin:0;padding:10px;color:#fff;opacity:.8}.shared-module--SocialLink--Ya1gh:hover{opacity:1}.shared-module--SocialLink--Ya1gh svg{height:1.8rem;fill:#fff}.shared-module--SiteHeader--11Q-_{position:relative;padding-top:12px;padding-bottom:12px;color:#fff;background:#15171a no-repeat 50%;background-size:cover}.shared-module--SiteHeaderContent--EPPk3{display:flex;flex-direction:column;justify-content:center;align-items:center;padding:10vw 4vw;min-height:200px;max-height:450px;text-align:center}.shared-module--SiteHeaderStyles--2X95r{content:"";position:absolute;top:0;right:0;bottom:auto;left:0;z-index:10;display:block;height:80px;background:-webkit-gradient(linear,left top,left bottom,from(rgba(0,0,0,.1)),to(transparent));background:linear-gradient(rgba(0,0,0,.1),transparent)}.shared-module--SiteHeaderStyles--2X95r:before{content:"";position:absolute;top:0;right:0;bottom:0;left:0;z-index:10;display:block;background:rgba(0,0,0,.18)}.shared-module--SiteHeaderStyles--2X95r:after{content:"";position:absolute;top:0;right:0;bottom:auto;left:0;z-index:10;display:block;height:80px;background:-webkit-gradient(linear,left top,left bottom,from(rgba(0,0,0,.1)),to(transparent));background:linear-gradient(rgba(0,0,0,.1),transparent)}@media (max-width:700px){.shared-module--SiteHeaderStyles--2X95r{padding-right:0;padding-left:0}}.shared-module--AuthorProfileImage--3bfVw{display:block;background:#c5d2d9;border-radius:100%;-o-object-fit:cover;object-fit:cover;margin-right:15px;width:60px;height:60px}.sitenav-module--container--2f7Mf{position:relative;z-index:300;display:flex;justify-content:space-between;align-items:flex-start;overflow-y:hidden;height:40px;font-size:1.2rem}.sitenav-module--container--2f7Mf .sitenav-module--SiteNavLeft--37Wnn{display:flex;align-items:center;overflow-x:auto;overflow-y:hidden;margin-right:10px;padding-bottom:80px;letter-spacing:.4px;white-space:nowrap;-webkit-overflow-scrolling:touch;-ms-overflow-scrolling:touch}@media (max-width:700px){.sitenav-module--container--2f7Mf .sitenav-module--SiteNavLeft--37Wnn{margin-right:0;padding-left:4vw}}.sitenav-module--container--2f7Mf .sitenav-module--SiteNavRight--2MOoa{flex-shrink:0;display:flex;align-items:center;height:40px}@media (max-width:700px){.sitenav-module--container--2f7Mf .sitenav-module--SiteNavRight--2MOoa{display:none}}.sitenav-module--container--2f7Mf .sitenav-module--SiteNavRight--2MOoa .sitenav-module--SocialLinks--3bj4A{flex-shrink:0;display:flex;align-items:center}.sitenav-module--container--2f7Mf .sitenav-module--SiteNavRight--2MOoa .sitenav-module--SocialLinks--3bj4A a:last-of-type{padding-right:20px}.sitenav-module--container--2f7Mf .sitenav-module--SiteNavRight--2MOoa .sitenav-module--SubscribeButton--3gIQb{display:block;padding:4px 10px;border:1px solid #fff;color:#fff;font-size:1.2rem;line-height:1em;border-radius:10px;opacity:.8}.sitenav-module--container--2f7Mf .sitenav-module--SiteNavRight--2MOoa .sitenav-module--SubscribeButton--3gIQb :hover{text-decoration:none;opacity:1;cursor:pointer}@media (min-width:900px){.sitenav-module--HomeNavRaise--2C7hy{position:relative;top:-70px}}SiteNavStyles{position:relative;z-index:300;display:flex;justify-content:space-between;align-items:flex-start;overflow-y:hidden;height:40px;font-size:1.2rem}.sitenav-module--NavStyles--gmMAk{display:flex;margin:0 0 0 -12px;padding:0;list-style:none}.sitenav-module--NavStyles--gmMAk li{display:block;margin:0;padding:0;text-transform:uppercase}.sitenav-module--NavStyles--gmMAk li a{display:block;margin:0;padding:10px 12px;color:#fff;opacity:.8}.sitenav-module--NavStyles--gmMAk li a:hover{text-decoration:none;opacity:1}.postCard-module--container--3MBpY{flex:1 1 300px;display:flex;flex-direction:column;overflow:hidden;margin:0 20px 40px;min-height:300px;background:#fff 50%;background-size:cover;border-radius:5px;box-shadow:8px 14px 38px rgba(39,44,49,.06),1px 3px 8px rgba(39,44,49,.03);-webkit-transition:all .5s ease;transition:all .5s ease}.postCard-module--container--3MBpY:hover{box-shadow:8px 28px 50px rgba(39,44,49,.07),1px 6px 12px rgba(39,44,49,.04);-webkit-transition:all .4s ease;transition:all .4s ease;-webkit-transform:translate3D(0,-1px,0) scale(1.02);transform:translate3D(0,-1px,0) scale(1.02)}.postCard-module--PostCardImageLink--1-_rO{position:relative;display:block;overflow:hidden;border-radius:5px 5px 0 0}.postCard-module--PostCardImage--1ooSS{width:auto;height:200px;background:#d3d3d3 no-repeat 50%;background-size:cover}.postCard-module--PostCardContent--LjkYR{flex-grow:1;display:flex;flex-direction:column;justify-content:space-between}.postCard-module--PostCardContentLink--37umd{position:relative;flex-grow:1;display:block;padding:25px 25px 0;color:#15171a}.postCard-module--PostCardContentLink--37umd:hover{text-decoration:none}.postCard-module--PostCardTags--jyRjj{display:block;margin-bottom:4px;color:#647a83;font-size:1.2rem;line-height:1.15em;font-weight:500;letter-spacing:.5px;text-transform:uppercase}.postCard-module--PostCardTitle--1JrkM{margin-top:0}.postCard-module--PostCardExcerpt--3gUSF{font-family:Georgia,serif}.postCard-module--PostCardMeta--2EEJ7{display:flex;justify-content:space-between;align-items:flex-end;padding:0 25px 25px}.postCard-module--AuthorList--12tT0{display:flex;flex-wrap:wrap-reverse;margin:0;padding:0;list-style:none}.postCard-module--AuthorListItem--32xbX{position:relative;flex-shrink:0;margin:0;padding:0}.postCard-module--AuthorListItem--32xbX :first-of-type{z-index:10}.postCard-module--AuthorListItem--32xbX :nth-of-type(2){z-index:9}.postCard-module--AuthorListItem--32xbX :nth-of-type(3){z-index:8}.postCard-module--AuthorListItem--32xbX :nth-of-type(4){z-index:7}.postCard-module--AuthorListItem--32xbX :nth-of-type(5){z-index:6}.postCard-module--AuthorListItem--32xbX :nth-of-type(6){z-index:5}.postCard-module--AuthorListItem--32xbX :nth-of-type(7){z-index:4}.postCard-module--AuthorListItem--32xbX :nth-of-type(8){z-index:3}.postCard-module--AuthorListItem--32xbX :nth-of-type(9){z-index:2}.postCard-module--AuthorListItem--32xbX :nth-of-type(10){z-index:1}.postCard-module--AuthorListItem--32xbX:hover .postCard-module--AuthorNameTooltip--1xdhE{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}.postCard-module--AuthorNameTooltip--1xdhE{position:absolute;bottom:105%;z-index:999;display:block;padding:2px 8px;color:#fff;font-size:1.2rem;letter-spacing:.2px;white-space:nowrap;background:#15171a;border-radius:3px;box-shadow:0 12px 26px rgba(39,44,49,.08),1px 3px 8px rgba(39,44,49,.03);opacity:0;-webkit-transition:all .3s cubic-bezier(.4,.01,.165,.99);transition:all .3s cubic-bezier(.4,.01,.165,.99);-webkit-transform:translateY(6px);transform:translateY(6px);pointer-events:none}@media (max-width:650px){.postCard-module--AuthorNameTooltip--1xdhE{display:none}}.postCard-module--StaticAvatar--3PQRl{display:block;overflow:hidden;margin:0 -5px;width:34px;height:34px;border:2px solid #fff;border-radius:100%}.postCard-module--AuthorProfileImage--31jei{display:block;width:100%;height:100%;background:#c5d2d9;border-radius:100%;-o-object-fit:cover;object-fit:cover}.postCard-module--ReadingTime--3LVUu{flex-shrink:0;margin-left:20px;color:#647a83;font-size:1.2rem;line-height:33px;font-weight:500;letter-spacing:.5px;text-transform:uppercase}.PostFullContent{position:relative;margin:0 auto;padding:70px 100px 0;min-height:230px;font-family:Georgia,serif;font-size:2.2rem;line-height:1.6em;background:#fff}@media (max-width:1170px){.PostFullContent{padding:5vw 7vw 0}}@media (max-width:800px){.PostFullContent{font-size:1.9rem}}.PostFullContent:before{left:-5px;-webkit-transform:rotate(-5deg);transform:rotate(-5deg)}.PostFullContent:after,.PostFullContent:before{content:"";position:absolute;top:15px;z-index:-1;display:block;width:20px;height:200px;background:rgba(39,44,49,.15);-webkit-filter:blur(5px);filter:blur(5px)}.PostFullContent:after{right:-5px;-webkit-transform:rotate(5deg);transform:rotate(5deg)}.PostFullContent .footnotes,.PostFullContent .post-full-comments,.PostFullContent blockquote,.PostFullContent dl,.PostFullContent h1,.PostFullContent h2,.PostFullContent h3,.PostFullContent h4,.PostFullContent h5,.PostFullContent h6,.PostFullContent ol,.PostFullContent p,.PostFullContent pre,.PostFullContent ul{min-width:100%}.PostFullContent li{word-break:break-word}.PostFullContent li p{margin:0}.PostFullContent a{color:#000;word-break:break-word;box-shadow:inset 0 -1px 0 #0f7dba}.PostFullContent a:hover{color:#0f7dba;text-decoration:none}.PostFullContent em,.PostFullContent strong{color:#15171a}.PostFullContent small{display:inline-block;line-height:1.6em}.PostFullContent li:first-of-type{margin-top:0}.PostFullContent .gatsby-resp-image-link{box-shadow:none}.PostFullContent img,.PostFullContent video{display:block;margin:1.5em auto;max-width:1040px;height:auto}@media (max-width:1040px){.PostFullContent img,.PostFullContent video{width:100%}}.PostFullContent img[src$="#full"]{max-width:none;width:100vw}.PostFullContent img+br+small{display:block;margin-top:-3em;margin-bottom:1.5em;text-align:center}.PostFullContent iframe{margin:0 auto!important}.PostFullContent blockquote{margin:0 0 1.5em;padding:0 1.5em;border-left:3px solid #0f7dba}.PostFullContent blockquote p{margin:0 0 1em;color:inherit;font-size:inherit;line-height:inherit;font-style:italic}.PostFullContent blockquote p:last-child{margin-bottom:0}.PostFullContent code{padding:0 5px 2px;font-size:.8em;line-height:1em;font-weight:400!important;background:#e5eff5;border-radius:3px}.PostFullContent p code{word-break:break-all}.PostFullContent pre{overflow-x:auto;padding:20px;max-width:100%;border:1px solid #15171a;color:#e5eff5;font-size:1.4rem;line-height:1.5em;background:#15171a;border-radius:5px}.PostFullContent pre code{padding:0;font-size:inherit;line-height:inherit;background:transparent}.PostFullContent pre code :not(span){color:inherit}.PostFullContent .gatsby-resp-iframe-wrapper{margin:1.5em 0 3em}.PostFullContent hr{margin:4vw 0}.PostFullContent hr:after{content:"";position:absolute;top:-15px;left:50%;display:block;margin-left:-10px;width:1px;height:30px;background:#c5d2d9;box-shadow:0 0 0 5px #fff;-webkit-transform:rotate(45deg);transform:rotate(45deg)}.PostFullContent h1,.PostFullContent h2,.PostFullContent h3,.PostFullContent h4,.PostFullContent h5,.PostFullContent h6{color:#15171a;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif}.PostFullContent h1{margin:.5em 0 .2em;font-size:4.6rem;font-weight:700}@media (max-width:500px){.PostFullContent h1{font-size:2.8rem}}.PostFullContent h2{margin:.5em 0 .2em;font-size:3.6rem;font-weight:700}@media (max-width:500px){.PostFullContent h2{font-size:2.6rem}}.PostFullContent h3{margin:.5em 0 .2em;font-size:2.8rem;font-weight:700}@media (max-width:500px){.PostFullContent h3{font-size:2.2rem}}.PostFullContent h4{margin:.5em 0 .2em;font-size:2.8rem;font-weight:700}@media (max-width:500px){.PostFullContent h4{font-size:2.2rem}}.PostFullContent h5{display:block;margin:.5em 0;padding:1em 0 1.5em;border:0;color:#0f7dba;font-family:Georgia,serif;font-size:3.2rem;line-height:1.35em;text-align:center}@media (min-width:1180px){.PostFullContent h5{max-width:1060px}}@media (max-width:500px){.PostFullContent h5{padding:0 0 .5em;font-size:2.2rem}}.PostFullContent h6{margin:.5em 0 .2em;font-size:2.3rem;font-weight:700}@media (max-width:500px){.PostFullContent h6{font-size:2rem}}.PostFullContent table{display:inline-block;overflow-x:auto;margin:.5em 0 2.5em;max-width:100%;width:auto;border-spacing:0;border-collapse:collapse;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;font-size:1.6rem;white-space:nowrap;vertical-align:top;-webkit-overflow-scrolling:touch;background:radial-gradient(ellipse at left,rgba(0,0,0,.2) 0,transparent 75%) 0,radial-gradient(ellipse at right,rgba(0,0,0,.2) 0,transparent 75%) 100%;background-attachment:scroll,scroll;background-size:10px 100%,10px 100%;background-repeat:no-repeat}.PostFullContent table td:first-of-type{background-image:-webkit-gradient(linear,left top,right top,color-stop(50%,#fff),to(hsla(0,0%,100%,0)));background-image:linear-gradient(90deg,#fff 50%,hsla(0,0%,100%,0));background-size:20px 100%;background-repeat:no-repeat}.PostFullContent table td:last-child{background-image:-webkit-gradient(linear,right top,left top,color-stop(50%,#fff),to(hsla(0,0%,100%,0)));background-image:linear-gradient(270deg,#fff 50%,hsla(0,0%,100%,0));background-position:100% 0;background-size:20px 100%;background-repeat:no-repeat}.PostFullContent table th{color:#15171a;font-size:1.2rem;font-weight:700;letter-spacing:.2px;text-align:left;text-transform:uppercase;background-color:#e5eff5}.PostFullContent table td,.PostFullContent table th{padding:6px 12px;border:1px solid #e5eff5}@media (max-width:500px){.PostFullContent{padding:0}.PostFullContent :after,.PostFullContent :before{display:none}}.PostFullContent code[class*=language-],.PostFullContent pre[class*=language-]{background:none;font-family:Consolas,Menlo,Monaco,source-code-pro,Courier New,monospace;font-feature-settings:normal;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;margin-bottom:0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}.PostFullContent pre[class*=language-]{overflow:auto;padding:1.3125rem}.PostFullContent pre[class*=language-]::selection{background:#27292a}.PostFullContent pre[class*=language-]::selection,.PostFullContent pre[class*=language-] ::selection{text-shadow:none;background:hsla(0,0%,100%,.15)}.PostFullContent :not(pre)>code[class*=language-]{border-radius:.3em;background:var(--inlineCode-bg);color:var(--inlineCode-text);padding:.15em .2em .05em;white-space:normal}.PostFullContent .token.attr-name{color:#addb67;font-style:italic}.PostFullContent .token.comment{color:#809393}.PostFullContent .token.string,.PostFullContent .token.url{color:#addb67}.PostFullContent .token.variable{color:#d6deeb}.PostFullContent .token.number{color:#f78c6c}.PostFullContent .token.builtin,.PostFullContent .token.char,.PostFullContent .token.constant,.PostFullContent .token.function{color:#82aaff}.PostFullContent .token.punctuation{color:#c792ea}.PostFullContent .token.doctype,.PostFullContent .token.selector{color:#c792ea;font-style:italic}.PostFullContent .token.class-name{color:#ffcb8b}.PostFullContent .token.keyword,.PostFullContent .token.operator,.PostFullContent .token.tag{color:#ffa7c4}.PostFullContent .token.boolean{color:#ff5874}.PostFullContent .token.property{color:#80cbc4}.PostFullContent .token.namespace{color:#b2ccd6}.PostFullContent pre[data-line]{padding:1em 0 1em 3em;position:relative}.PostFullContent .gatsby-highlight-code-line{background-color:#022a4b;display:block;margin-right:-1.3125rem;margin-left:-1.3125rem;padding-right:1em;padding-left:1.25em;border-left:.25em solid #ffa7c4}.PostFullContent .gatsby-highlight{margin-bottom:1.75rem;margin-left:-1.3125rem;margin-right:-1.3125rem;border-radius:10px;background:#011627;-webkit-overflow-scrolling:touch;overflow:auto}@media (max-width:672px){.PostFullContent .gatsby-highlight{border-radius:0}}.PostFullContent .gatsby-highlight pre[class*=language-]{float:left;min-width:100%}.postFullFooter-module--container--2PA5n{display:flex;justify-content:space-between;align-items:center;margin:0 auto;padding:3vw 0 6vw;max-width:840px}.postFullFooterRight-module--container--1A7hv{flex-shrink:0;margin-left:20px}.postFullFooterRight-module--container--1A7hv .postFullFooterRight-module--authorCardButton--2Zo5V{display:block;padding:9px 16px;border:1px solid #647b84;color:#647a83;font-size:1.2rem;line-height:1;font-weight:500;border-radius:20px;-webkit-transition:all .2s ease;transition:all .2s ease}.postFullFooterRight-module--container--1A7hv .postFullFooterRight-module--authorCardButton--2Zo5V:hover{border-color:#0f7dba;color:#0f7dba;text-decoration:none}.wrapper-module--container--39cxo{display:flex;flex-direction:column;min-height:100vh}a,abbr,acronym,address,applet,article,aside,audio,big,blockquote,body,canvas,caption,cite,code,dd,del,details,dfn,div,dl,dt,em,embed,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,html,iframe,img,ins,kbd,label,legend,li,mark,menu,nav,object,ol,output,p,pre,q,ruby,s,samp,section,small,span,strike,strong,sub,summary,sup,table,tbody,td,tfoot,th,thead,time,tr,tt,ul,var,video{margin:0;padding:0;border:0;font:inherit;font-size:100%;vertical-align:baseline}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:after,blockquote:before,q:after,q:before{content:"";content:none}img{max-width:100%}html{box-sizing:border-box;font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}*,:after,:before{box-sizing:inherit}a{background-color:transparent}a:active,a:hover{outline:0}b,strong{font-weight:700}dfn,em,i{font-style:italic}h1{margin:.67em 0;font-size:2em}small{font-size:80%}sub,sup{position:relative;font-size:75%;line-height:0;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}img{border:0}svg:not(:root){overflow:hidden}mark{background-color:#fdffb6}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit}button{overflow:visible;border:none}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{cursor:pointer;-webkit-appearance:button}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}input:focus{outline:none}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{box-sizing:content-box;-webkit-appearance:textfield}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}legend{padding:0;border:0}textarea{overflow:auto}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}html{overflow-y:scroll;font-size:62.5%;-webkit-tap-highlight-color:rgba(0,0,0,0)}body,html{overflow-x:hidden}body{color:#2d373b;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;font-size:1.5rem;line-height:1.6em;font-weight:400;font-style:normal;letter-spacing:0;text-rendering:optimizeLegibility;background:#fff;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-moz-font-feature-settings:"liga" on}::selection{text-shadow:none;background:#6fc4f3}hr{position:relative;display:block;width:100%;margin:2.5em 0 3.5em;padding:0;height:1px;border:0;border-top:1px solid #e4eaed}audio,canvas,iframe,img,svg,video{vertical-align:middle}fieldset{margin:0;padding:0;border:0}textarea{resize:vertical}blockquote,dl,ol,p,ul{margin:0 0 1.5em}ol,ul{padding-left:1.3em;padding-right:1.5em}ol ol,ol ul,ul ol,ul ul{margin:.5em 0 1em}ul{list-style:disc}ol{list-style:decimal}ol,ul{max-width:100%}li{margin:.5em 0;padding-left:.3em;line-height:1.6em}dt{float:left;margin:0 20px 0 0;width:120px;color:#15171a;font-weight:500;text-align:right}dd{margin:0 0 5px;text-align:left}blockquote{margin:1.5em 0;padding:0 1.6em;border-left:.5em solid #e5eff5}blockquote p{margin:.8em 0;font-size:1.2em;font-weight:300}blockquote small{display:inline-block;margin:.8em 0 .8em 1.5em;font-size:.9em;opacity:.8}blockquote small:before{content:"\\2014 \\00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:400}a{color:#0d6da2;text-decoration:none}a:hover{text-decoration:underline}h1,h2,h3,h4,h5,h6{margin-top:0;line-height:1.15;font-weight:700;text-rendering:optimizeLegibility}h1{margin:0 0 .5em;font-size:5rem;font-weight:700}@media (max-width:500px){h1{font-size:2.2rem}}h2{margin:1.5em 0 .5em;font-size:2rem}@media (max-width:500px){h2{font-size:1.8rem}}h3{margin:1.5em 0 .5em;font-size:1.8rem;font-weight:500}@media (max-width:500px){h3{font-size:1.7rem}}h4{margin:1.5em 0 .5em;font-size:1.6rem;font-weight:500}h5,h6{margin:1.5em 0 .5em;font-size:1.4rem;font-weight:500}body{background:#f4f8fb}.pagination-module--container--jH0P2{padding:0 4vw 4vh;background:#fff;text-align:center}.pagination-module--container--jH0P2 div{display:inline-block}.pagination-module--container--jH0P2 a{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell;background:#fff;color:#000;float:left;padding:8px 16px;text-decoration:none;-webkit-transition:background-color .3s;transition:background-color .3s;border:1px solid #ddd;box-shadow:8px 14px 38px rgba(39,44,49,.06),1px 3px 8px rgba(39,44,49,.03);border-radius:6px;margin:0 4px 5px;min-width:50px}.pagination-module--container--jH0P2 a.pagination-module--active--2gHKl{box-shadow:inset 3px 0 0 0 #141619}.pagination-module--container--jH0P2 a:hover:not(.pagination-module--active--2gHKl){background-color:#ddd}.pagination-module--container--jH0P2 a:hover{text-decoration:none}.pagination-module--container--jH0P2 .pagination-module--ellipsis--xvUoZ{padding:8px;min-width:40px;pointer-events:none;cursor:default;opacity:.6}@media (max-width:550px){.pagination-module--container--jH0P2 .pagination-module--ellipsis--xvUoZ{min-width:30px}}@media (max-width:400px){.pagination-module--container--jH0P2 .pagination-module--ellipsis--xvUoZ{display:none}}@media (max-width:550px){.pagination-module--container--jH0P2 .pagination-module--next--1rF_K,.pagination-module--container--jH0P2 .pagination-module--previous--WUxFk{display:none}}.readNextCard-module--container--J4I2n{position:relative;flex:1 1 300px;display:flex;flex-direction:column;overflow:hidden;margin:0 20px 40px;padding:25px;color:#fff;background:#15171a 50%;background-size:cover;border-radius:5px;box-shadow:8px 14px 38px rgba(39,44,49,.06),1px 3px 8px rgba(39,44,49,.03)}.readNextCard-module--container--J4I2n:before{content:"";position:absolute;top:0;right:0;bottom:0;left:0;display:block;background:linear-gradient(135deg,rgba(0,40,60,.8),rgba(0,20,40,.7));border-radius:5px;-webkit-backdrop-filter:blur(2px);backdrop-filter:blur(2px)}.readNextCard-module--ReadNextCardHeader--3M6PZ{position:relative;z-index:50;padding-top:20px;text-align:center}.readNextCard-module--ReadNextCardHeaderSitetitle--1FkpC{display:block;font-size:1.3rem;line-height:1.3em;opacity:.8}.readNextCard-module--ReadNextCardHeaderTitle--3qnwx{margin:0;padding:0 20px;color:#fff;font-size:3rem;line-height:1.2em;letter-spacing:1px}.readNextCard-module--ReadNextCardHeaderTitle--3qnwx a{color:#fff;font-weight:300;text-decoration:none}.readNextCard-module--ReadNextCardHeaderTitle--3qnwx a:hover{text-decoration:none}.readNextCard-module--ReadNextDivider--1WD0f{position:relative;display:flex;justify-content:center;height:80px}.readNextCard-module--ReadNextDivider--1WD0f svg{width:40px;fill:transparent;stroke:#fff;stroke-width:.5px;stroke-opacity:.65}.readNextCard-module--ReadNextCardContent--phuA0{position:relative;z-index:50;flex-grow:1;display:flex;font-size:1.7rem}.readNextCard-module--ReadNextCardContent--phuA0 ul{display:flex;flex-direction:column;margin:0 auto;padding:0;text-align:center;list-style:none}.readNextCard-module--ReadNextCardContent--phuA0 li{margin:0;padding:0;font-size:1.6rem;line-height:1.25em;font-weight:200;letter-spacing:-.5px}.readNextCard-module--ReadNextCardContent--phuA0 li a{display:block;padding:20px 0;border-bottom:1px solid hsla(0,0%,100%,.3);color:#fff;font-weight:500;vertical-align:top;-webkit-transition:opacity .3s ease;transition:opacity .3s ease}.readNextCard-module--ReadNextCardContent--phuA0 li:first-of-type a{padding-top:10px}.readNextCard-module--ReadNextCardContent--phuA0 li a:hover{opacity:1}.readNextCard-module--ReadNextCardFooter--jt8zz{position:relative;margin:15px 0 3px;text-align:center}.readNextCard-module--ReadNextCardFooter--jt8zz a{color:#fff}#site-main{background:#fff;padding-bottom:4vw}.PostFull{position:relative;z-index:50}.NoImage .post-full-content{padding-top:0}.NoImage .post-full-content:after,.NoImage .post-full-content:before{display:none}.PostFullHeader{margin:0 auto;padding:6vw 3vw 3vw;max-width:1040px;text-align:center}@media (max-width:500px){.PostFullHeader{padding:14vw 3vw 10vw}}.PostFullMeta{display:flex;justify-content:center;align-items:center;color:#647a83;font-size:1.4rem;font-weight:600;text-transform:uppercase}@media (max-width:500px){.PostFullMeta{font-size:1.2rem;line-height:1.3em}}.PostFullMetaDate{color:#0f7dba}.PostFullTitle{margin:0;color:#15171a}@media (max-width:500px){.PostFullTitle{font-size:2.9rem}}.PostFullImage{margin:0 -10vw -165px;height:800px;background:#c5d2d9 50%;background-size:cover;border-radius:5px}@media (max-width:1170px){.PostFullImage{margin:0 -4vw -100px;height:600px;border-radius:0}}@media (max-width:800px){.PostFullImage{height:400px}}@media (max-width:500px){.PostFullImage{margin-bottom:4vw;height:350px}}.DateDivider{display:inline-block;margin:0 6px 1px}.ReadNextFeed{display:flex;flex-wrap:wrap;margin:0 -20px;padding:40px 0 0}.progress-read-module--container--Xf3HB{background:#e5eff5;height:5px;width:100vw;opacity:1%;position:fixed;top:0;z-index:200}.progress-read-module--container--Xf3HB .progress-read-module--bar--2CgAA{background:#0f7dba;height:100%}site-main{background:#fff;padding-bottom:4vw}._404-module--siteNavCenter--1xW_t{display:flex;justify-content:center;align-items:center;text-align:center}._404-module--siteNavCenter--1xW_t .site-nav-logo{margin-right:0}._404-module--errorTemplate--2Q6Vk{padding:7vw 4vw}._404-module--errorTemplate--2Q6Vk ._404-module--errorCode--Iss6n{margin:0;font-size:12vw;line-height:1em;letter-spacing:-5px;opacity:.3}._404-module--errorTemplate--2Q6Vk ._404-module--errorDescription--1CGfX{margin:0;color:#647a83;font-size:3rem;line-height:1.3em;font-weight:400}._404-module--errorTemplate--2Q6Vk ._404-module--errorLink--3fWWe{display:inline-block;margin-top:5px}</style><meta name="generator" content="Gatsby 2.18.21"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-b3b573358bfc66d89e1e95dbf8319c09.css"/><link rel="canonical" href="https://ludovicwyffels.dev/node-architecture/" data-baseprotocol="https:" data-basehost="ludovicwyffels.dev"/><title data-react-helmet="true">Architecture d&#x27;un projet node.js Bulletproof</title><link data-react-helmet="true" rel="icon" href="/static/favicon-36e47e74810a0d8c32a77f495c49cf8e.ico" type="image/x-icon"/><meta data-react-helmet="true" name="description" content="Introduction Express.js est un excellent framework pour la cr√©ation d‚Äôune API REST en node.js, mais il ne vous donne aucune indication sur‚Ä¶"/><meta data-react-helmet="true" property="og:site_name" content="Code avec Ludo"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="og:title" content="Architecture d&#x27;un projet node.js Bulletproof"/><meta data-react-helmet="true" property="og:description" content="Introduction Express.js est un excellent framework pour la cr√©ation d‚Äôune API REST en node.js, mais il ne vous donne aucune indication sur‚Ä¶"/><meta data-react-helmet="true" property="og:url" content="https://ludovicwyffels.github.io/node-architecture/"/><meta data-react-helmet="true" property="og:image" content="https://ludovicwyffels.github.io/static/7b5ca6b968847300f44022d2d8670c4a/e817e/rock-zen.jpg"/><meta data-react-helmet="true" property="article:published_time" content="2019-04-20T08:00:00.000Z"/><meta data-react-helmet="true" property="article:tag" content="Architecture"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:title" content="Architecture d&#x27;un projet node.js Bulletproof"/><meta data-react-helmet="true" name="twitter:description" content="Introduction Express.js est un excellent framework pour la cr√©ation d‚Äôune API REST en node.js, mais il ne vous donne aucune indication sur‚Ä¶"/><meta data-react-helmet="true" name="twitter:url" content="https://ludovicwyffels.github.io/node-architecture/"/><meta data-react-helmet="true" name="twitter:image" content="https://ludovicwyffels.github.io/static/7b5ca6b968847300f44022d2d8670c4a/e817e/rock-zen.jpg"/><meta data-react-helmet="true" name="twitter:label1" content="Written by"/><meta data-react-helmet="true" name="twitter:data1" content="ludo"/><meta data-react-helmet="true" name="twitter:label2" content="Filed under"/><meta data-react-helmet="true" name="twitter:data2" content="Architecture"/><meta data-react-helmet="true" property="og:image:width" content="2250"/><meta data-react-helmet="true" property="og:image:height" content="1500"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script>
  window.excludeGAPaths=[/^(?:\/preview\/(?:(?!(?:\/|^)\.).)*?)$/];
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-138733938-1',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(!(parseInt(navigator.doNotTrack) === 1 || parseInt(window.doNotTrack) === 1 || parseInt(navigator.msDoNotTrack) === 1 || navigator.doNotTrack === "yes")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-138733938-1', 'auto', {"sampleRate":100,"siteSpeedSampleRate":10});
      ga('set', 'anonymizeIp', true);
      
      
      
      
      }</script><link as="script" rel="preload" href="/webpack-runtime-87635273e2e9b7f21522.js"/><link as="script" rel="preload" href="/app-c04b935d4dae2219afe9.js"/><link as="script" rel="preload" href="/styles-a8b87cae742df2ef8275.js"/><link as="script" rel="preload" href="/commons-5ba6458b00d23e27bf58.js"/><link as="script" rel="preload" href="/component---src-templates-post-tsx-1c7a3e14e4aa37adf2d3.js"/><link as="fetch" rel="preload" href="/page-data/node-architecture/page-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div class="post-template"><style data-emotion-css="0"></style><div class="progress-read-module--container--Xf3HB" style="display:none"><div class="progress-read-module--bar--2CgAA" style="width:0%"></div></div><div class="wrapper-module--container--39cxo PostTemplate"><style data-emotion-css="7n4c3k">.css-7n4c3k{position:relative;padding:0 4vw;position:relative;padding-top:12px;padding-bottom:12px;color:#fff;background:#0a0b0c no-repeat center center;background-size:cover;}</style><header class="css-7n4c3k"><style data-emotion-css="s2cjas">.css-s2cjas{margin:0 auto;max-width:1040px;width:100%;}</style><div class="css-s2cjas"><nav class="false sitenav-module--container--2f7Mf"><div class="sitenav-module--SiteNavLeft--37Wnn"><a class="site-nav-logo siteNavLogo-module--container--2Eieh" href="/"><img src="/static/7d3993478cb88fc18c502e8e98013386/c0bbd/logo.png" alt="Code avec Ludo"/></a><ul class="sitenav-module--NavStyles--gmMAk" role="menu"><li role="menuitem"><a href="/">Home</a></li><li role="menuitem"><a href="/tags/node-js/">Node.js</a></li><li role="menuitem"><a href="/tags/dev-ops/">DevOps</a></li><li role="menuitem"><a href="/about">About</a></li></ul></div><div class="sitenav-module--SiteNavRight--2MOoa"><div class="sitenav-module--SocialLinks--3bj4A"><a class="shared-module--SocialLink--Ya1gh" href="https://github.com/ludovicwyffels" title="Github" target="_blank" rel="noopener noreferrer"><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Github</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a></div></div></nav></div></header><style data-emotion-css="9696is">.css-9696is{z-index:100;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;position:relative;padding:0 4vw;}</style><main id="site-main" class="site-main css-9696is"><style data-emotion-css="s2cjas">.css-s2cjas{margin:0 auto;max-width:1040px;width:100%;}</style><div class="css-s2cjas"><style data-emotion-css="1cj30xk">.css-1cj30xk{position:relative;z-index:50;}</style><article class="css-1cj30xk"><header class="PostFullHeader"><section class="PostFullMeta"><time dateTime="2019-04-20T08:00:00.000Z" class="PostFullMetaDate">20 April 2019</time><span class="DateDivider">/</span><a href="/tags/architecture/">Architecture</a><style data-emotion-css="bosr71">.css-bosr71{width:10px;}</style><div class="css-bosr71"></div><a href="/tags/node-js/">Node.js</a><div class="css-bosr71"></div></section><h1 class="PostFullTitle">Architecture d&#x27;un projet node.js Bulletproof</h1></header><figure class="PostFullImage"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;height:100%"><div style="width:100%;padding-bottom:66.66666666666667%"></div><img src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAQX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAv/aAAwDAQACEAMQAAABpznuGEpc/wD/xAAaEAEBAAIDAAAAAAAAAAAAAAABAgARAxIh/9oACAEBAAEFAiBK6zTxmx9qdus//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEREv/aAAgBAwEBPwGIwj//xAAYEQACAwAAAAAAAAAAAAAAAAAAAQIREv/aAAgBAgEBPwG5G2f/xAAZEAACAwEAAAAAAAAAAAAAAAAAARAhMRH/2gAIAQEABj8Cvgk9Lcaaf//EABgQAQEBAQEAAAAAAAAAAAAAAAEAESEx/9oACAEBAAE/ITnRgGapmh2ZnE1yevV//9oADAMBAAIAAwAAABCL/wD/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxBif//EABYRAQEBAAAAAAAAAAAAAAAAAAEQMf/aAAgBAgEBPxAB2f8A/8QAHBABAQACAgMAAAAAAAAAAAAAAREAQSGBYXHR/9oACAEBAAE/EDBaCJT7l6ghJLrjWP6Ll3ggFO3IiIXir7xVTtmf/9k=" alt="" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/7b5ca6b968847300f44022d2d8670c4a/1f72c/rock-zen.jpg 930w,
/static/7b5ca6b968847300f44022d2d8670c4a/d7cf8/rock-zen.jpg 1860w,
/static/7b5ca6b968847300f44022d2d8670c4a/e817e/rock-zen.jpg 2250w" sizes="(max-width: 2250px) 100vw, 2250px" /><img loading="lazy" sizes="(max-width: 2250px) 100vw, 2250px" srcset="/static/7b5ca6b968847300f44022d2d8670c4a/1f72c/rock-zen.jpg 930w,
/static/7b5ca6b968847300f44022d2d8670c4a/d7cf8/rock-zen.jpg 1860w,
/static/7b5ca6b968847300f44022d2d8670c4a/e817e/rock-zen.jpg 2250w" src="/static/7b5ca6b968847300f44022d2d8670c4a/e817e/rock-zen.jpg" alt="" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></figure><section class="post-full-content PostFullContent"><div><h2>Introduction</h2>
<p>Express.js est un excellent framework pour la cr√©ation d‚Äôune API REST en node.js, mais il ne vous donne aucune indication sur la mani√®re d‚Äôorganiser votre projet node.js.</p>
<p>Bien que cela puisse para√Ætre stupide, c‚Äôest un probl√®me r√©el.</p>
<p>Une organisation correcte de la structure de votre projet node.js √©vitera la duplication de code, am√©liorera la stabilit√© et, √©ventuellement, vous aidera √† faire √©voluer vos services si cela est effectu√© correctement.</p>
<p>Cet article est une recherche approfondie, issue de mes ann√©es d‚Äôexp√©rience dans le traitement d‚Äôun projet node.js mal structur√©, de mauvais sch√©mas et d‚Äôinnombrables heures de refactorisation de code et de d√©placements.</p>
<h2>Table des mati√®res</h2>
<ul>
<li><a href="#folder">La structure du dossier üè¢</a></li>
<li><a href="#architecture">Architecture √† 3 couches ü•™</a></li>
<li><a href="#service">Couche service üíº</a></li>
<li><a href="#pubsub">Couche Pub/Sub Ô∏èÔ∏èÔ∏èÔ∏èüéôÔ∏èÔ∏è</a></li>
<li><a href="#di">Injection de d√©pendances üíâ</a></li>
<li><a href="#test">Test unitaire üïµüèª</a></li>
<li><a href="#cron">Cron Jobs et t√¢ches r√©currentes ‚ö°</a></li>
<li><a href="#configs">Configurations et secrets ü§´</a></li>
<li><a href="#loaders">Loaders üèóÔ∏è</a></li>
</ul>
<p><a name="folder"></a></p>
<h2>La structure du dossier üè¢</h2>
<p>Voici la structure du projet node.js dont je parle.</p>
<p>J‚Äôutilise ceci dans chaque service d‚ÄôAPI REST de node.js que je construis. Voyons en d√©tail ce que chaque composant fait.</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset:linenumber NaN" class="language-text line-numbers"><code class="language-text">src
‚îÇ   app.js          # App entry point
‚îî‚îÄ‚îÄ‚îÄapi             # Express route controllers for all the endpoints of the app
‚îî‚îÄ‚îÄ‚îÄconfig          # Environment variables and configuration related stuff
‚îî‚îÄ‚îÄ‚îÄjobs            # Jobs definitions for agenda.js
‚îî‚îÄ‚îÄ‚îÄloaders         # Split the startup process into modules
‚îî‚îÄ‚îÄ‚îÄmodels          # Database models
‚îî‚îÄ‚îÄ‚îÄservices        # All the business logic is here
‚îî‚îÄ‚îÄ‚îÄsubscribers     # Event handlers for async task
‚îî‚îÄ‚îÄ‚îÄtypes           # Type declaration files (d.ts) for Typescript</code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>C‚Äôest plus qu‚Äôun moyen de commander des fichiers JavaScript‚Ä¶</p>
<p><a name="architecture"></a></p>
<h2>Architecture √† 3 couches ü•™</h2>
<p>L‚Äôid√©e est d‚Äôutiliser le <strong>principe de s√©paration des pr√©occupations</strong> pour √©loigner la logique m√©tier des routes de l‚ÄôAPI node.js.</p>
<p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:755px">
      <a class="gatsby-resp-image-link" href="/static/e7549783fc618ca44dcc8daef066a986/06940/server_layers.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:78.41059602649007%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAABi0lEQVQ4y4WU646CMBCFff8X9AcCMZFE7oKKF8DufpOcCRjdbTJpaWfOzJzTsnm9XmGaptC2bei67qP1fR/O57PZNx9snuewCb/j8XgYIBvP5zOM4+jG9/V6NbDL5bLa10xBTdPY2gFx/jQISpIkbLfbsN/vw7dBwhWgMtzvd7Pb7eZrDB9M3xSgNXHEk3wDh7SKA1loj8OqqsIwDN6qzpnhi4r1zYwvWAYoYcTH6XQKWZZZIlUmUxckFIeKM0DxVNe1Z2R9OBxsTeYlBXyjOiLirxtAV4A6h2x+Gjgej0dLkuf5V/EAXonCBoOylzMgqAtomqZW2XLID14dkEVRFH5BCaIy1ohEu8y0S4WckwSuMfzg1FqWKMtsAIgChMF0GxgEItoyRmu/NlRAdsBoM4oiB3436CnL0mMknqsMh5AuNfXU2NdToypmkuMnKqS+X+y/nh687HY74yuOY7tKPEMA/n16kEvJqkY0AIoItMiMeAByrqqJ48wB9bdALSmHwdXyyelpvvvJSPIDQV3ZnsiBHJsAAAAASUVORK5CYII=&#x27;);background-size:cover;display:block"></span>
  <picture>
        <source srcSet="/static/e7549783fc618ca44dcc8daef066a986/14b47/server_layers.webp 293w, /static/e7549783fc618ca44dcc8daef066a986/91928/server_layers.webp 585w, /static/e7549783fc618ca44dcc8daef066a986/54ad7/server_layers.webp 755w" sizes="(max-width: 755px) 100vw, 755px" type="image/webp"/>
        <source srcSet="/static/e7549783fc618ca44dcc8daef066a986/b6dd9/server_layers.png 293w, /static/e7549783fc618ca44dcc8daef066a986/037e5/server_layers.png 585w, /static/e7549783fc618ca44dcc8daef066a986/06940/server_layers.png 755w" sizes="(max-width: 755px) 100vw, 755px" type="image/png"/>
        <img class="gatsby-resp-image-image" src="/static/e7549783fc618ca44dcc8daef066a986/06940/server_layers.png" alt="3 layer pattern" title="3 layer pattern" loading="lazy" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0"/>
      </picture>
  </a>
    </span></p>
<p>Parce qu‚Äôun jour, vous voudrez utiliser votre logique m√©tier sur un outil CLI, ou ne pas aller tr√®s loin, dans une t√¢che r√©currente.</p>
<p>Et faire un appel API du serveur node.js √† lui-m√™me, ce n‚Äôest pas une bonne id√©e‚Ä¶</p>
<p> <span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:652px">
      <a class="gatsby-resp-image-link" href="/static/8ba15b5b22a1a677396ca792a04418e3/ad6dd/server_layers_2.png" style="display:block" target="_blank" rel="noopener">
    <span class="gatsby-resp-image-background-image" style="padding-bottom:81.13496932515338%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAABd0lEQVQ4y42TWY/CMAyE+f8/ri+8tQ9V1Zaj0Isbepj9LDlKsyxaS0NC6kzG42Q1z7NM0ySv12uB5/P5FX7eMAxiPCv5CT4cDgc5n89yOp0U1+tV7ve73G63BR6Ph1wuF5fHnqZplBhSJeQPBH6QlKap5Hkum81GiqJQJEmixH7YwYQjhADpKGDsuk52u50cj0ep69qN+/1eCcLcBeE4jrqIfMC8bVvdiHIfkGRZJtvtVv9b6XBoyfyAsAQI/wo8DMteNAXZlNP3vZ6GZ6hgYwhyyLV8qgHWaechi1a+Kab7eIe/5iHfUQKYE9j0qykshsGpKC3LUkcQ2kPgpSMkASVVVbkS8A81dh99sEZDuLfMzQJ3D/2m2OgrpjQzHBCUbxb5e7UpNrGXABl3jfIo2crxX4opY84at8IOdh5Swqd7Z0ThuoE9NI1x0ZTwXtnzW6/XEsexPsMoilRZGB+fHr6ECkni7uHnN4X2qlyXqT/06r8wUmvaG9Vj2kbgv3TmAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <picture>
        <source srcSet="/static/8ba15b5b22a1a677396ca792a04418e3/14b47/server_layers_2.webp 293w, /static/8ba15b5b22a1a677396ca792a04418e3/91928/server_layers_2.webp 585w, /static/8ba15b5b22a1a677396ca792a04418e3/23d72/server_layers_2.webp 652w" sizes="(max-width: 652px) 100vw, 652px" type="image/webp"/>
        <source srcSet="/static/8ba15b5b22a1a677396ca792a04418e3/b6dd9/server_layers_2.png 293w, /static/8ba15b5b22a1a677396ca792a04418e3/037e5/server_layers_2.png 585w, /static/8ba15b5b22a1a677396ca792a04418e3/ad6dd/server_layers_2.png 652w" sizes="(max-width: 652px) 100vw, 652px" type="image/png"/>
        <img class="gatsby-resp-image-image" src="/static/8ba15b5b22a1a677396ca792a04418e3/ad6dd/server_layers_2.png" alt="3 layer pattern for node.js REST API" title="3 layer pattern for node.js REST API" loading="lazy" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0"/>
      </picture>
  </a>
    </span></p>
<h3>Ne placez pas votre logique m√©tier dans les contr√¥leurs !!!</h3>
<p>Vous pouvez √™tre tent√© d‚Äôutiliser simplement les contr√¥leurs express.js pour stocker la logique m√©tier de votre application, mais cela devient rapidement du code spaghetti. D√®s que vous aurez besoin d‚Äô√©crire des tests unitaires, vous finirez par avoir affaire √† des mocks complexes pour des objets express.js tel que <code>req</code> ou <code>res</code>.</p>
<p>Il est difficile de distinguer quand une r√©ponse doit √™tre envoy√©e et quand continuer le traitement en ‚Äúarri√®re-plan‚Äù, disons apr√®s que la r√©ponse a √©t√© envoy√©e au client.</p>
<p>Voici un exemple de ce qu‚Äôil ne faut pas faire.</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js">route<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token comment">// This should be a middleware or should be handled by a library like Joi.</span>
  <span class="token keyword">const</span> userDTO <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> isUserValid <span class="token operator">=</span> validators<span class="token punctuation">.</span><span class="token function">user</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isUserValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Lot of business logic here...</span>
  <span class="token keyword">const</span> userRecord <span class="token operator">=</span> <span class="token keyword">await</span> UserModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> userRecord<span class="token punctuation">.</span>password<span class="token punctuation">;</span>
  <span class="token keyword">delete</span> userRecord<span class="token punctuation">.</span>salt<span class="token punctuation">;</span>
  <span class="token keyword">const</span> companyRecord <span class="token operator">=</span> <span class="token keyword">await</span> CompanyModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> companyDashboard <span class="token operator">=</span> <span class="token keyword">await</span> CompanyDashboard<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">,</span> companyRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">...</span>whatever<span class="token operator">...</span>


  <span class="token comment">// And here is the &#x27;optimization&#x27; that mess up everything.</span>
  <span class="token comment">// The response is sent to client...</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token operator">:</span> userRecord<span class="token punctuation">,</span> company<span class="token operator">:</span> companyRecord <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// But code execution continues :(</span>
  <span class="token keyword">const</span> salaryRecord <span class="token operator">=</span> <span class="token keyword">await</span> SalaryModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">,</span> companyRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  eventTracker<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span><span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span>userRecord<span class="token punctuation">,</span>companyRecord<span class="token punctuation">,</span>salaryRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  intercom<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  gaAnalytics<span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span><span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span>userRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> EmailService<span class="token punctuation">.</span><span class="token function">startSignupSequence</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a name="service"></a></p>
<h2>Utilisez une couche de service pour votre logique m√©tier üíº</h2>
<p>Cette couche est l‚Äôendroit o√π votre logique m√©tier doit vivre.</p>
<p>C‚Äôest juste un ensemble de classes, suivant les principes SOLID appliqu√©s √† node.js.</p>
<p><em>Dans cette couche, il ne devrait exister aucune forme de ‚Äúrequ√™te SQL‚Äù, utilisez la couche d‚Äôacc√®s aux donn√©es pour cela.</em></p>
<ul>
<li>√âloignez votre code du routeur express.js</li>
<li>Ne transmettez pas l‚Äôobjet req ou res √† la couche service</li>
<li>Ne renvoyez aucun √©l√©ment li√© √† la couche de transport HTTP, tel qu‚Äôun code d‚Äô√©tat ou des en-t√™tes de la couche de service.</li>
</ul>
<p><strong>Exemple</strong></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js">route<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">,</span> 
  validators<span class="token punctuation">.</span>userSignup<span class="token punctuation">,</span> <span class="token comment">// this middleware take care of validation</span>
  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// The actual responsability of the route layer.</span>
    <span class="token keyword">const</span> userDTO <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token comment">// Call to service layer.</span>
    <span class="token comment">// Abstraction on how to access the data layer and the business logic.</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> UserService<span class="token punctuation">.</span><span class="token function">Signup</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Return a response to client.</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Voici comment votre service travaillera dans les coulisses.</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> UserModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> CompanyModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/company&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token keyword">async</span> <span class="token function">Signup</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> userRecord <span class="token operator">=</span> <span class="token keyword">await</span> UserModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> companyRecord <span class="token operator">=</span> <span class="token keyword">await</span> CompanyModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// needs userRecord to have the database id </span>
  <span class="token keyword">const</span> salaryRecord <span class="token operator">=</span> <span class="token keyword">await</span> SalaryModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">,</span> companyRecord<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// depends on user and company to be created</span>

  <span class="token operator">...</span>whatever

  <span class="token keyword">await</span> EmailService<span class="token punctuation">.</span><span class="token function">startSignupSequence</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span>

  <span class="token operator">...</span><span class="token keyword">do</span> more stuff

  <span class="token keyword">return</span> <span class="token punctuation">{</span> user<span class="token operator">:</span> userRecord<span class="token punctuation">,</span> company<span class="token operator">:</span> companyRecord <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a name="pubsub"></a></p>
<h2>Utilisez aussi un calque Pub/Sub üéôÔ∏èÔ∏è</h2>
<p>Le mod√®le pub/sub va au-del√† de l‚Äôarchitecture classique √† 3 couches propos√©e ici, mais il est extr√™mement utile.</p>
<p>Le simple endpoint de l‚ÄôAPI node.js qui cr√©e un utilisateur imm√©diatement, peut vouloir appeler des services tiers, peut-√™tre √† un service d‚Äôanalyse, ou peut-√™tre d√©marrer une s√©quence de courriels.</p>
<p>T√¥t ou tard, cette simple op√©ration ‚Äúcr√©er‚Äù fera plusieurs choses, et vous obtiendrez 1000 lignes de code, le tout en une seule fonction.</p>
<p>Cela viole le principe de la responsabilit√© unique.</p>
<p>Il est donc pr√©f√©rable de s√©parer les responsabilit√©s d√®s le d√©part, afin que votre code reste maintenable.</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> UserModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> CompanyModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/company&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> SalaryModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/salary&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">async</span> <span class="token function">Signup</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userRecord <span class="token operator">=</span> <span class="token keyword">await</span> UserModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> companyRecord <span class="token operator">=</span> <span class="token keyword">await</span> CompanyModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> salaryRecord <span class="token operator">=</span> <span class="token keyword">await</span> SalaryModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> salary<span class="token punctuation">)</span><span class="token punctuation">;</span>

    eventTracker<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span>
      <span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span>
      userRecord<span class="token punctuation">,</span>
      companyRecord<span class="token punctuation">,</span>
      salaryRecord
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    intercom<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>
      userRecord
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    gaAnalytics<span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>
      <span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span>
      userRecord
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> EmailService<span class="token punctuation">.</span><span class="token function">startSignupSequence</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span>

    <span class="token operator">...</span>more stuff

    <span class="token keyword">return</span> <span class="token punctuation">{</span> user<span class="token operator">:</span> userRecord<span class="token punctuation">,</span> company<span class="token operator">:</span> companyRecord <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Un appel imp√©ratif √† un service d√©pendant n‚Äôest pas la meilleure fa√ßon de le faire.</p>
<p>Une meilleure approche est d‚Äô√©mettre un √©v√©nement, c‚Äôest-√†-dire ‚Äúun utilisateur s‚Äôest inscrit avec cet email‚Äù.</p>
<p>Et vous avez termin√©, c‚Äôest maintenant la responsabilit√© des listeners de faire leur travail.</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> UserModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> CompanyModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/company&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> SalaryModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/salary&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">async</span> <span class="token function">Signup</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userRecord <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> companyRecord <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>companyModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>eventEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> user<span class="token operator">:</span> userRecord<span class="token punctuation">,</span> company<span class="token operator">:</span> companyRecord <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> userRecord
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Vous pouvez maintenant scinder les gestionnaires d‚Äô√©v√©nements/listeners en plusieurs fichiers.</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js">eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  eventTracker<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span>
    <span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span>
    user<span class="token punctuation">,</span>
    company<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  intercom<span class="token punctuation">.</span><span class="token function">createUser</span><span class="token punctuation">(</span>
    user
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  gaAnalytics<span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>
    <span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span>
    user
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js">eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> salaryRecord <span class="token operator">=</span> <span class="token keyword">await</span> SalaryModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> company<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span></span></pre></div>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js">eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&#x27;user_signup&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> EmailService<span class="token punctuation">.</span><span class="token function">startSignupSequence</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span></span></pre></div>
<p>Vous pouvez mettre les instructions en attente dans un bloc <code>try-catch</code> ou vous pouvez simplement le laisser √©chouer et g√©rer le  ‚ÄòunhandledPromise‚Äô <code>process.on(&#x27;unhandledRejection&#x27;,cb)</code></p>
<p><a name="di"></a></p>
<h2>Injection de d√©pendances üíâ</h2>
<p><code>Dependency Injection</code> (D.I.) ou <code>inversion of control</code> (IoC) est un mod√®le commun qui aidera l‚Äôorganisation de votre code, en ‚Äúinjectant‚Äù ou en passant par le constructeur les d√©pendances de votre classe ou fonction.</p>
<p>De cette fa√ßon, vous aurez la possibilit√© d‚Äôinjecter une ‚Äúd√©pendance compatible‚Äù lorsque, par exemple, vous √©crirez les tests unitaires pour le service, ou lorsque le service sera utilis√© dans un autre contexte.</p>
<p><em>Code sans D.I.</em></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> UserModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> CompanyModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/company&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> SalaryModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/salary&#x27;</span><span class="token punctuation">;</span>  
<span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">Sigup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// Caling UserMode, CompanyModel, etc</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><em>Code avec injection manuelle de d√©pendance</em></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">userModel<span class="token punctuation">,</span> companyModel<span class="token punctuation">,</span> salaryModel</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>userModel <span class="token operator">=</span> userModel<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>companyModel <span class="token operator">=</span> companyModel<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>salaryModel <span class="token operator">=</span> salaryModel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">getMyUser</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// models available throug &#x27;this&#x27;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userModel<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Vous pouvez maintenant injecter des d√©pendances personnalis√©es.</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> UserService <span class="token keyword">from</span> <span class="token string">&#x27;../services/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> UserModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> CompanyModel <span class="token keyword">from</span> <span class="token string">&#x27;../models/company&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> salaryModelMock <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">calculateNetSalary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">42</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> userServiceInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span>userModel<span class="token punctuation">,</span> companyModel<span class="token punctuation">,</span> salaryModelMock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> userServiceInstance<span class="token punctuation">.</span><span class="token function">getMyUser</span><span class="token punctuation">(</span><span class="token string">&#x27;12346&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Le nombre de d√©pendances qu‚Äôun service peut avoir est infini, et refactoriser chaque instanciation de celui-ci lorsque vous en ajoutez un nouveau est une t√¢che ennuyeuse et sujette aux  erreurs.</p>
<p>C‚Äôest pourquoi des frameworks d‚Äôinjection de d√©pendance ont √©t√© cr√©√©s.</p>
<p>L‚Äôid√©e est de d√©clarer vos d√©pendances dans la classe, et quand vous avez besoin d‚Äôune instance de cette classe, vous appelez simplement le <code>Service Locator</code>.</p>
<p>Voyons un exemple utilisant <a href="https://www.npmjs.com/package/typedi" target="_blank" rel="nofollow noopener noreferrer"><code>typedi</code>, une biblioth√®que npm</a> qui apporte l‚Äôinjection de d√©pendances √† node.js</p>
<p>Pour en savoir plus sur l‚Äôutilisation de <code>typedi</code>, consultez la <a href="https://github.com/typestack/typedi" target="_blank" rel="nofollow noopener noreferrer">documentation officielle</a></p>
<p>AVERTISSEMENT exemple en typescript</p>
<div class="gatsby-highlight" data-language="typescript"><pre style="counter-reset:linenumber NaN" class="language-typescript line-numbers"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Service <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;typedi&#x27;</span><span class="token punctuation">;</span>
@<span class="token function">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token parameter"><span class="token keyword">private</span> userModel<span class="token punctuation">,</span>
    <span class="token keyword">private</span> companyModel<span class="token punctuation">,</span> 
    <span class="token keyword">private</span> salaryModel</span>
  <span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">getMyUser</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userModel<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<blockquote>
<p>services/user.ts</p>
</blockquote>
<p>Maintenant <em>typedi</em> s‚Äôoccupera de r√©soudre toute d√©pendance dont le <code>UserService</code> a besoin.</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">{</span> Container <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;typedi&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> UserService <span class="token keyword">from</span> <span class="token string">&#x27;../services/user&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> userServiceInstance <span class="token operator">=</span> Container<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>UserService<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> userServiceInstance<span class="token punctuation">.</span><span class="token function">getMyUser</span><span class="token punctuation">(</span><span class="token string">&#x27;12346&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span></span></pre></div>
<p><em>L‚Äôabus d‚Äôappels de localisateur de service est un anti-pattern</em></p>
<p>Utilisation de l‚Äôinjection de d√©pendance avec Express.js dans Node.js</p>
<p>L‚Äôutilisation de D.I. dans express.js est la derni√®re pi√®ce du puzzle de l‚Äôarchitecture de ce projet node.js.</p>
<p><strong>Couche de routage</strong></p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js">route<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">,</span> 
  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userDTO <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">const</span> userServiceInstance <span class="token operator">=</span> Container<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>UserService<span class="token punctuation">)</span> <span class="token comment">// Service locator</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span> <span class="token operator">=</span> userServiceInstance<span class="token punctuation">.</span><span class="token function">Signup</span><span class="token punctuation">(</span>userDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token punctuation">,</span> company <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>G√©nial, le projet √† l‚Äôair g√©nial !
C‚Äôest tellement organis√© que j‚Äôai envie de coder quelque chose en ce moment.</p>
<p><a name="test"></a></p>
<h2>Un exemple de test unitaire üïµüèª</h2>
<p>En utilisant l‚Äôinjection de d√©pendance et ces mod√®les d‚Äôorganisation, le test unitaire devient vraiment simple.</p>
<p>Vous n‚Äôavez pas besoin de simuler des objets req/res ou de require(‚Ä¶)</p>
<p><strong>Exemple: Test unitaire pour la m√©thode d‚Äôinscription de l‚Äôutilisateur</strong></p>
<blockquote>
<p>tests/unit/services/user.js</p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> UserService <span class="token keyword">from</span> <span class="token string">&#x27;../../../src/services/user&#x27;</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;User service unit tests&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;Signup&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;Should create user record and emit user_signup event&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> eventEmitterService <span class="token operator">=</span> <span class="token punctuation">{</span>
        emit<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> userModel <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">create</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>user<span class="token punctuation">,</span>
            _id<span class="token operator">:</span> <span class="token string">&#x27;mock-user-id&#x27;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> companyModel <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">create</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span>
            owner<span class="token operator">:</span> user<span class="token punctuation">.</span>_id<span class="token punctuation">,</span>
            companyTaxId<span class="token operator">:</span> <span class="token string">&#x27;12345&#x27;</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> userInput<span class="token operator">=</span> <span class="token punctuation">{</span>
        fullname<span class="token operator">:</span> <span class="token string">&#x27;User Unit Test&#x27;</span><span class="token punctuation">,</span>
        email<span class="token operator">:</span> <span class="token string">&#x27;test@example.com&#x27;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> userService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span>userModel<span class="token punctuation">,</span> companyModel<span class="token punctuation">,</span> eventEmitterService<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> userRecord <span class="token operator">=</span> <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">SignUp</span><span class="token punctuation">(</span>teamId<span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userInput<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">expect</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeDefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>userRecord<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeDefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>eventEmitterService<span class="token punctuation">.</span>emit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a name="cron"></a></p>
<h2>Cron Jobs et t√¢ches r√©currentes ‚ö°</h2>
<p>Ainsi, maintenant que la logique m√©tier est encapsul√©e dans la couche service, il est plus facile de l‚Äôutiliser depuis un job Cron.</p>
<p>Vous ne devriez jamais compter sur <code>setTimeout</code> ou une autre fa√ßon primitive de retarder l‚Äôex√©cution du code, mais sur un framework qui persiste vos jobs, et l‚Äôex√©cution de ceux-ci, dans une base de donn√©es.</p>
<p>De cette fa√ßon, vous aurez le contr√¥le sur les jobs √©chou√©s, et la r√©troaction de ceux qui r√©ussissent.</p>
<p><a name="configs"></a></p>
<h2>Configurations et secrets ü§´</h2>
<p>Suivant les concepts √©prouv√©s de <a href="https://12factor.net/" target="_blank" rel="nofollow noopener noreferrer">Twelve-Factor App</a> pour node.js, la meilleure approche pour stocker les cl√©s API et les cha√Ænes de connexions aux base de donn√©es, c‚Äôest en utilisant <strong>dotenv</strong>.</p>
<p>Mettez un fichier <code>.env</code>, qui ne doit jamais √™tre valid√© <em>(mais qui doit exister avec des valeurs par d√©faut dans votre r√©f√©rentiel)</em> puis, le paquet npm <code>dotenv</code> charge le fichier <code>.env</code> et insert les variables dans l‚Äôobjet <code>process.env</code> de node.js.</p>
<p>Cela pourrait suffire, mais j‚Äôaimerais ajouter une √©tape suppl√©mentaire.
Avoir un fichier <code>config/index.ts</code> o√π le paquet npm <code>dotenv</code> et charge le fichier <code>.env</code> et puis j‚Äôutilise un objet pour stocker les variables, dons nous avons une structure et un code d‚Äôautocompl√©tion.</p>
<blockquote>
<p>config/index.js</p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> dotenv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;dotenv&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// config() will read your .env file, parse the contents, assign it to process.env.</span>
dotenv<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  port<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span>
  databaseURL<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URI</span><span class="token punctuation">,</span>
  paypal<span class="token operator">:</span> <span class="token punctuation">{</span>
    publicKey<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PAYPAL_PUBLIC_KEY</span><span class="token punctuation">,</span>
    secretKey<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PAYPAL_SECRET_KEY</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  paypal<span class="token operator">:</span> <span class="token punctuation">{</span>
    publicKey<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PAYPAL_PUBLIC_KEY</span><span class="token punctuation">,</span>
    secretKey<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PAYPAL_SECRET_KEY</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  mailchimp<span class="token operator">:</span> <span class="token punctuation">{</span>
    apiKey<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MAILCHIMP_API_KEY</span><span class="token punctuation">,</span>
    sender<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MAILCHIMP_SENDER</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>De cette fa√ßon, vous √©vitez d‚Äôinonder votre code avec les instructions <code>process.env.MY_RANDOM_VAR</code>, et en ayant l‚Äôautocompl√©tion vous n‚Äôavez pas besoin de savoir comment nommer la variable d‚Äôenvironnement.</p>
<p><a name="loaders"></a></p>
<h2>Loaders üèóÔ∏è</h2>
<p>J‚Äôai pris ce mod√®le du <a href="https://www.npmjs.com/package/microframework-w3tec" target="_blank" rel="nofollow noopener noreferrer">microframework de W3Tech</a> mais sans d√©pendre de leur paquet.</p>
<p>L‚Äôid√©e est de diviser le processus de d√©marrage de votre service node.js en modules testables.</p>
<p>Voyons une initialisation d‚Äôapplication express.js classique</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;mongoose&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;express&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;body-parser&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;express-session&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;cors&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> errorhandler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;errorhandler&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/status&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token string">&#x27;/status&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;morgan&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&#x27;dev&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>setupForStripeWebhooks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;method-override&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">&#x27;/public&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span> secret<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SECRET</span><span class="token punctuation">,</span> cookie<span class="token operator">:</span> <span class="token punctuation">{</span> maxAge<span class="token operator">:</span> <span class="token number">60000</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useNewUrlParser<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./config/passport&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./models/user&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./models/company&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./routes&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#x27;Not Found&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  err<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#x27;errors&#x27;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    message<span class="token operator">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
    error<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token operator">...</span> more stuff 

<span class="token operator">...</span> maybe start up Redis

<span class="token operator">...</span> maybe add more middlewares

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    
  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Your server is ready !</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Run the async function to start our server</span>
<span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Comme vous le voyez, cette partie de votre application peut √™tre un vrai g√¢chis.</p>
<p>Voici une fa√ßon efficace d‚Äôy faire face.</p>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">const</span> loaders <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./loaders&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;express&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> loaders<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> expressApp<span class="token operator">:</span> app <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Your server is ready !</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Maintenant, les chargeurs ne sont plus que de minuscules fichiers avec un but concis</p>
<blockquote>
<p>loders/index.js</p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> expressLoader <span class="token keyword">from</span> <span class="token string">&#x27;./express&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> mongooseLoader <span class="token keyword">from</span> <span class="token string">&#x27;./mongoose&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> expressApp <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mongoConnection <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">mongooseLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;MongoDB Intialized&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">expressLoader</span><span class="token punctuation">(</span><span class="token punctuation">{</span> app<span class="token operator">:</span> expressApp <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;Express Intialized&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ... more loaders can be here</span>

  <span class="token comment">// ... Initialize agenda</span>
  <span class="token comment">// ... or Redis, or whatever you want}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Le loader express</p>
<blockquote>
<p>loaders/express.js</p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> express <span class="token keyword">from</span> <span class="token string">&#x27;express&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> bodyParser <span class="token keyword">from</span> <span class="token string">&#x27;body-parser&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> cors <span class="token keyword">from</span> <span class="token string">&#x27;cors&#x27;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> app <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> app<span class="token operator">:</span> express<span class="token punctuation">.</span>Application <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/status&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token string">&#x27;/status&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">enable</span><span class="token punctuation">(</span><span class="token string">&#x27;trust proxy&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;morgan&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">&#x27;dev&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...More middlewares</span>

  <span class="token comment">// Return the express app</span>
  <span class="token keyword">return</span> app<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Le loader mongo</p>
<blockquote>
<p>loaders/mongoose.js</p>
</blockquote>
<div class="gatsby-highlight" data-language="js"><pre style="counter-reset:linenumber NaN" class="language-js line-numbers"><code class="language-js"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> mongoose <span class="token keyword">from</span> <span class="token string">&#x27;mongoose&#x27;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">await</span> mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DATABASE_URL</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useNewUrlParser<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> connection<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>db<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space:normal;width:auto;left:0"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a name="conclusion"></a></p>
<h2>Conclusion</h2>
<p>Nous plongeons en profondeur dans la structure d‚Äôun projet node.js test√© en production, voici quelques conseils r√©sum√©s:</p>
<ul>
<li>Utiliser une architecture √† 3 couches.</li>
<li>Ne mettez pas votre logique m√©tier dans les contr√¥leurs express.js</li>
<li>Ayez l‚Äôinjection de d√©pendance pour votre tranquillit√© d‚Äôesprit.</li>
<li>Ne divulguez jamais vos mots de passe, secrets et cl√©s API, utilisez un gestionnaire de configuration.</li>
<li>Divisez vos configurations de serveur node.js en petits modules qui peuvent √™tre charg√©s ind√©pendamment.</li>
</ul></div></section><footer class="postFullFooter-module--container--2PA5n"><section class="authorCard-module--authorCardSection--3Xspq"><style data-emotion-css="2785xc">.css-2785xc{display:block;background:#e4eaed;border-radius:100%;object-fit:cover;margin-right:15px;width:60px;height:60px;}</style><img src="/static/5f2c129e42248a92c87b13b4293950cf/c684e/ghost.png" alt="ludo" class="css-2785xc"/><section class="authorCard-module--authorCardContent--3jBBV"><div class="authorCard-module--authorCardName--3HnMH"><a href="/author/ludo/">Ludovic Wyffels</a></div><p>D√©veloppeur senior. Fullstack + DevOps</p></section></section><div class="postFullFooterRight-module--container--1A7hv"><a class="postFullFooterRight-module--authorCardButton--2Zo5V" href="/author/ludo/">Read More</a></div></footer></article></div></main><style data-emotion-css="1x0l29j">.css-1x0l29j{position:relative;padding:0 4vw;}</style><aside class="read-next css-1x0l29j"><style data-emotion-css="s2cjas">.css-s2cjas{margin:0 auto;max-width:1040px;width:100%;}</style><div class="css-s2cjas"><div class="ReadNextFeed"><style data-emotion-css="4dw642">.css-4dw642{background-image:url(/static/9fb9647467dab072b9ebe36e9e52ae95/7ac0b/blog-cover.jpg);}</style><article class="readNextCard-module--container--J4I2n css-4dw642 el9ui1o0"><header class="readNextCard-module--ReadNextCardHeader--3M6PZ"><small class="readNextCard-module--ReadNextCardHeaderSitetitle--1FkpC">‚Äî <!-- -->Code avec Ludo<!-- --> ‚Äî</small><h3 class="readNextCard-module--ReadNextCardHeaderTitle--3qnwx"><a href="/tags/architecture/">Architecture</a></h3></header><div class="readNextCard-module--ReadNextDivider--1WD0f"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><title>Infinity</title><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"></path></svg></div><div class="readNextCard-module--ReadNextCardContent--phuA0"><ul><li><a aria-current="page" class="" href="/node-architecture/">Architecture d&#x27;un projet node.js Bulletproof</a></li></ul></div><footer class="readNextCard-module--ReadNextCardFooter--jt8zz"><a href="/tags/architecture/">1 post<!-- --> ‚Üí</a></footer></article><article class="postCard-module--container--3MBpY post-card "><a class="post-card-image-link postCard-module--PostCardImageLink--1-_rO" href="/js-conditions/"><div class="post-card-image postCard-module--PostCardImage--1ooSS"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;height:100%"><div style="width:100%;padding-bottom:56.25%"></div><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAtElEQVQoz2P4cNufbMRAV83vb4EQyZo/3/P/dNf/28OAr/cDIPoZiLQNqPPeaZ9nl3zP7fW6fNDr872A90RqfnvD/8/TwHmTnfpb7VMTLPasdfv2AGQ5sZr/vw2eM8lx8XTn6b2OM/ocifUz0AagVzcsds3LsFq3wGViu0N6kuWLK35AQQYigwroz5M7PN/e9Duwwf3WcR+Qn4l0NjBsgJ78/jDg4x3/n48CvpAU2sjRixzPABStw4O6JhVqAAAAAElFTkSuQmCC" alt="Comment √©crire de meilleures conditions en JavaScript cover image" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/f10109a249e0ae09b060bb7269f1f4be/37077/js.png 930w,
/static/f10109a249e0ae09b060bb7269f1f4be/c8bd7/js.png 1600w" sizes="(max-width: 1600px) 100vw, 1600px" /><img loading="lazy" sizes="(max-width: 1600px) 100vw, 1600px" srcset="/static/f10109a249e0ae09b060bb7269f1f4be/37077/js.png 930w,
/static/f10109a249e0ae09b060bb7269f1f4be/c8bd7/js.png 1600w" src="/static/f10109a249e0ae09b060bb7269f1f4be/c8bd7/js.png" alt="Comment √©crire de meilleures conditions en JavaScript cover image" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></div></a><div class="post-card-content postCard-module--PostCardContent--LjkYR"><a class="postCard-module--PostCardContentLink--37umd" href="/js-conditions/"><header><span class="postCard-module--PostCardTags--jyRjj"><span>#<!-- -->Javascript<!-- --> </span><span>#<!-- -->Node.js<!-- --> </span></span><h2 class="postCard-module--PostCardTitle--1JrkM">Comment √©crire de meilleures conditions en JavaScript</h2></header><section class="postCard-module--PostCardExcerpt--3gUSF"><p>1. Utilisez Array.includes pour plusieurs crit√®res Jetons un coup d‚Äôoeil √† l‚Äôexemple ci-dessous: √Ä premi√®re vue, l‚Äôexemple ci-dessus semble‚Ä¶</p></section></a><footer class="postCard-module--PostCardMeta--2EEJ7"><ul class="postCard-module--AuthorList--12tT0"><li class="postCard-module--AuthorListItem--32xbX"><div class="postCard-module--AuthorNameTooltip--1xdhE">Ludovic Wyffels</div><a class="postCard-module--StaticAvatar--3PQRl" href="/author/ludo/"><img class="postCard-module--AuthorProfileImage--31jei" src="/static/5f2c129e42248a92c87b13b4293950cf/c684e/ghost.png" alt="ludo"/></a></li></ul><span class="postCard-module--ReadingTime--3LVUu">8<!-- --> min read</span></footer></div></article><article class="postCard-module--container--3MBpY post-card "><a class="post-card-image-link postCard-module--PostCardImageLink--1-_rO" href="/react-timeline-component/"><div class="post-card-image postCard-module--PostCardImage--1ooSS"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;height:100%"><div style="width:100%;padding-bottom:56.25%"></div><img src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHGcgsuJA//xAAZEAADAQEBAAAAAAAAAAAAAAAAARECEBL/2gAIAQEAAQUCMZrk5Wemf//EABURAQEAAAAAAAAAAAAAAAAAABAR/9oACAEDAQE/AYf/xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAgEBPwGn/8QAFhAAAwAAAAAAAAAAAAAAAAAAACAx/9oACAEBAAY/Alp//8QAGhABAQACAwAAAAAAAAAAAAAAAQARITFBYf/aAAgBAQABPyEIAHV1G7G4Dhb3X//aAAwDAQACAAMAAAAQNy//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8Qrj//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQIBAT8Qjr//xAAbEAEAAgIDAAAAAAAAAAAAAAABABExQYHR8f/aAAgBAQABPxC3UQmjtlUpQcwHqKtLmC98/9k=" alt="Comment cr√©er une timeline avec React cover image" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/b5a5e890938c86b8a136334398b5352e/1f72c/react-timeline.jpg 930w,
/static/b5a5e890938c86b8a136334398b5352e/48ee2/react-timeline.jpg 1600w" sizes="(max-width: 1600px) 100vw, 1600px" /><img loading="lazy" sizes="(max-width: 1600px) 100vw, 1600px" srcset="/static/b5a5e890938c86b8a136334398b5352e/1f72c/react-timeline.jpg 930w,
/static/b5a5e890938c86b8a136334398b5352e/48ee2/react-timeline.jpg 1600w" src="/static/b5a5e890938c86b8a136334398b5352e/48ee2/react-timeline.jpg" alt="Comment cr√©er une timeline avec React cover image" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></div></a><div class="post-card-content postCard-module--PostCardContent--LjkYR"><a class="postCard-module--PostCardContentLink--37umd" href="/react-timeline-component/"><header><span class="postCard-module--PostCardTags--jyRjj"><span>#<!-- -->React<!-- --> </span><span>#<!-- -->Javascript<!-- --> </span></span><h2 class="postCard-module--PostCardTitle--1JrkM">Comment cr√©er une timeline avec React</h2></header><section class="postCard-module--PostCardExcerpt--3gUSF"><p>Ces derniers jours, je travaille sur une nouvelle page pour mon site web. Je voulais avoir une timeline pour pr√©senter certaines de mes‚Ä¶</p></section></a><footer class="postCard-module--PostCardMeta--2EEJ7"><ul class="postCard-module--AuthorList--12tT0"><li class="postCard-module--AuthorListItem--32xbX"><div class="postCard-module--AuthorNameTooltip--1xdhE">Ludovic Wyffels</div><a class="postCard-module--StaticAvatar--3PQRl" href="/author/ludo/"><img class="postCard-module--AuthorProfileImage--31jei" src="/static/5f2c129e42248a92c87b13b4293950cf/c684e/ghost.png" alt="ludo"/></a></li></ul><span class="postCard-module--ReadingTime--3LVUu">8<!-- --> min read</span></footer></div></article></div></div></aside><footer class="outer, footer-module--siteFooter--1ncU1"><div class="inner, footer-module--content--3f5hY"><section class="copyright"><a href="/">Code avec Ludo</a> ¬© <!-- -->2020<!-- --> </section><nav><a href="/">Latest Posts</a><a href="https://github.com/ludovicwyffels" target="_blank" rel="noopener noreferrer">Github</a></nav></div></footer></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/node-architecture/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-c04b935d4dae2219afe9.js"],"component---src-templates-index-tsx":["/component---src-templates-index-tsx-2640168869290a6f0d47.js"],"component---src-templates-post-tsx":["/component---src-templates-post-tsx-1c7a3e14e4aa37adf2d3.js"],"component---src-templates-tags-tsx":["/component---src-templates-tags-tsx-e8b5b778a3494d9f5f92.js"],"component---src-templates-category-tsx":["/component---src-templates-category-tsx-44214a297bcf40ccd05e.js"],"component---src-templates-author-tsx":["/component---src-templates-author-tsx-fa7a6c09c9cd68fb00a6.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-0a086defbb8e3ec57671.js"],"component---src-pages-about-tsx":["/component---src-pages-about-tsx-3b61b0c4abed5ab7d791.js"]};/*]]>*/</script><script src="/component---src-templates-post-tsx-1c7a3e14e4aa37adf2d3.js" async=""></script><script src="/commons-5ba6458b00d23e27bf58.js" async=""></script><script src="/styles-a8b87cae742df2ef8275.js" async=""></script><script src="/app-c04b935d4dae2219afe9.js" async=""></script><script src="/webpack-runtime-87635273e2e9b7f21522.js" async=""></script></body></html>